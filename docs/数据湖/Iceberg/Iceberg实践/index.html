<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-数据湖/Iceberg/Iceberg实践" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Iceberg实践 | 大数据Guide</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/docs/数据湖/Iceberg/Iceberg实践"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Iceberg实践 | 大数据Guide"><meta data-rh="true" name="description" content="Iceberg集成Hive"><meta data-rh="true" property="og:description" content="Iceberg集成Hive"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/docs/数据湖/Iceberg/Iceberg实践"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/数据湖/Iceberg/Iceberg实践" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/数据湖/Iceberg/Iceberg实践" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="大数据Guide RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="大数据Guide Atom Feed"><link rel="stylesheet" href="/assets/css/styles.69f2a557.css">
<script src="/assets/js/runtime~main.9ccc24a5.js" defer="defer"></script>
<script src="/assets/js/main.901e4aca.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">大数据Guide</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Flink/Flink SQL JOIN原理">大数据</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Flink/Flink SQL JOIN原理">Flink</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Hadoop/Hadoop实践">Hadoop</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Hive/Hive调优">Hive</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Kafka/Kafka实践">Kafka</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/OLAP/Clickhouse/Clickhouse存算分离">OLAP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Spark/Spark面试题1">Spark</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Zookeeper/Zookeeper面试题">Zookeeper</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/其他/Flume面试题">其他</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/数据仓库/数仓架构建设方法论">数据仓库</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/数据湖/Iceberg/Iceberg实践">数据湖</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/数据湖/Iceberg/Iceberg实践">Iceberg</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/数据湖/Iceberg/Iceberg实践">Iceberg实践</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">数据湖</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Iceberg</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Iceberg实践</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Iceberg实践</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iceberg集成hive">Iceberg集成Hive<a href="#iceberg集成hive" class="hash-link" aria-label="Direct link to Iceberg集成Hive" title="Direct link to Iceberg集成Hive">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="集成hive配置">集成Hive配置<a href="#集成hive配置" class="hash-link" aria-label="Direct link to 集成Hive配置" title="Direct link to 集成Hive配置">​</a></h3>
<blockquote>
<p>Hive 版本为3.1.2, Iceberg版本为1.3.0</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="添加jar包">添加jar包<a href="#添加jar包" class="hash-link" aria-label="Direct link to 添加jar包" title="Direct link to 添加jar包">​</a></h4>
<p>在Hive安装目录下添加2个Jar包</p>
<ul>
<li>iceberg-hive-runtime-1.3.0.jar</li>
<li>libfb303-0.9.3.jar(该包在Hive3.0后被Hive移除了，但是Iceberg需要使用这个包)</li>
</ul>
<ol>
<li>启动Hive shell,执行add jar命令添加jar包.</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">add jar /opt/hive-3.1.2-bin/auxlib/iceberg-hive-runtime-1.3.0.jar;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add jar /opt/hive-3.1.2-bin/auxlib/libfb303-0.9.3.jar;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置开启iceberg">配置开启Iceberg<a href="#配置开启iceberg" class="hash-link" aria-label="Direct link to 配置开启Iceberg" title="Direct link to 配置开启Iceberg">​</a></h4>
<ol>
<li>配置开启Iceberg</li>
</ol>
<p>在Hive客户端$HIVE_HOME/conf/hive-site.xml中添加如下配置：</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">iceberg.engine.hive.enabled</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>或者在Hive Shell中配置</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set iceberg.engine.hive.enabled=true;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="启动hive-metastore服务">启动Hive MetaStore服务<a href="#启动hive-metastore服务" class="hash-link" aria-label="Direct link to 启动Hive MetaStore服务" title="Direct link to 启动Hive MetaStore服务">​</a></h4>
<p>Iceberg需要连接HiveMetaStore用来作为Catalog，因此需要开<br>  启MetaStore服务<br>  先在hive-site.xml中配置metastore</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">hive.metastore.uris</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">thrift://hadoop2:9083</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">value</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">description</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Thrift URI for the remote metastore. Used by metastore client to connect to remote metastore.</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">description</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">property</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动Hive MetaStore服务</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> hive --service metastore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建表">创建表<a href="#创建表" class="hash-link" aria-label="Direct link to 创建表" title="Direct link to 创建表">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用hive默认的catalog">使用Hive默认的Catalog<a href="#使用hive默认的catalog" class="hash-link" aria-label="Direct link to 使用Hive默认的Catalog" title="Direct link to 使用Hive默认的Catalog">​</a></h4>
<p>如果没有设置iceberg.catalog属性，默认使用HiveCatalog来加载，这种方式就是说如果在Hive中创建Iceberg格式表时，不指定iceberg.catalog属性，那么数据存储在对应的hive warehouse路径下。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#在Hive中创建iceberg格式表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> test_iceberg_tbl1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partitioned </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dt string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stored </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>插入数据</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> test_iceberg_tbl1 </span><span class="token keyword" style="color:#00009f">values</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;zs&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">18</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;20211212&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="自定义hivecatalog名称">自定义HiveCatalog名称<a href="#自定义hivecatalog名称" class="hash-link" aria-label="Direct link to 自定义HiveCatalog名称" title="Direct link to 自定义HiveCatalog名称">​</a></h4>
<p>这种情况就是说在Hive中创建Iceberg格式表时，如果指定了iceberg.catalog属性值，那么数据存储在指定的catalog名称对应配置的目录下。其实自定义HiveCatalog的效果和默认的Hive Catalog一样,没什么区别。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> iceberg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">another_hive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">hive</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> iceberg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">another_hive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">uri</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">thrift:</span><span class="token comment" style="color:#999988;font-style:italic">//hadoop2:9083;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> iceberg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">another_hive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clients</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> iceberg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">another_hive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warehouse</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">hdfs:</span><span class="token comment" style="color:#999988;font-style:italic">//hadoop1:9098/warehouse/another_hive;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>创建表</p>
<div class="language-plsql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plsql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">create table another_hive.test_iceberg_tbl4(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partitioned by (dt string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stored by &#x27;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tblproperties (&#x27;iceberg.catalog&#x27;=&#x27;another_hive&#x27;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果要自定义表的存储路径，那么需要增加location属性，如下：</p>
<div class="language-plsql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plsql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">create table test_iceberg_tbl6(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partitioned by (dt string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stored by &#x27;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location  &#x27;/tmp/iceberg/test_iceberg_tbl5&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tblproperties (&#x27;iceberg.catalog&#x27;=&#x27;another_hive&#x27;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置hadoop-catalog">配置Hadoop Catalog<a href="#配置hadoop-catalog" class="hash-link" aria-label="Direct link to 配置Hadoop Catalog" title="Direct link to 配置Hadoop Catalog">​</a></h4>
<div class="language-plsql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plsql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SET iceberg.catalog.hadoop.type=hadoop;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SET iceberg.catalog.hadoop.warehouse=hdfs://hadoop1:9098/iceberg/warehouse;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>创建表</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> external </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> test_iceberg_tbl3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">partitioned </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dt string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stored </span><span class="token keyword" style="color:#00009f">by</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location </span><span class="token string" style="color:#e3116c">&#x27;hdfs://hadoop1:9098/iceberg/warehouse/default/test_iceberg_tbl3&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tblproperties </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;iceberg.catalog&#x27;</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;hadoop&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注意：以上location指定的路径必须是“iceberg.catalog.hadoop.warehouse”指定路径的子路径,格式必须是<code>${iceberg.catalog.hadoop.warehouse}</code>/ <code>${当前建表使用的hive库}</code>/ <code>${创建的当前iceberg表名}</code>。<br><strong>查看表结构</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTERNAL </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">test_iceberg_tbl3</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">id</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;from deserializer&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">name</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> string </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;from deserializer&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">age</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;from deserializer&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">dt</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> string </span><span class="token keyword" style="color:#00009f">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;from deserializer&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ROW</span><span class="token plain"> FORMAT SERDE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;org.apache.iceberg.mr.hive.HiveIcebergSerDe&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STORED </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;org.apache.iceberg.mr.hive.HiveIcebergStorageHandler&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> SERDEPROPERTIES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;serialization.format&#x27;</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;1&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LOCATION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;hdfs://hadoop1:9098/iceberg/warehouse/default/test_iceberg_tbl3&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TBLPROPERTIES </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;bucketing_version&#x27;</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;2&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;external.table.purge&#x27;</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;TRUE&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;iceberg.catalog&#x27;</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;hadoop&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;table_type&#x27;</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ICEBERG&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&#x27;transient_lastDdlTime&#x27;</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;1706019628&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>插入数据</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">insert</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> test_iceberg_tbl3 </span><span class="token keyword" style="color:#00009f">values</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;ww&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;20211213&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="iceberg集成spark">Iceberg集成Spark<a href="#iceberg集成spark" class="hash-link" aria-label="Direct link to Iceberg集成Spark" title="Direct link to Iceberg集成Spark">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spark代码">Spark代码<a href="#spark代码" class="hash-link" aria-label="Direct link to Spark代码" title="Direct link to Spark代码">​</a></h3>
<blockquote>
<p>版本：Spark 3.3.2 Iceberg 1.4.3</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="maven配置">Maven配置<a href="#maven配置" class="hash-link" aria-label="Direct link to Maven配置" title="Direct link to Maven配置">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;properties&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;spark.version&gt;3.3.2&lt;/spark.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;hive.version&gt;3.1.2&lt;/hive.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;scala.version&gt;2.12&lt;/scala.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;iceberg.version&gt;1.4.3&lt;/iceberg.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/properties&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;dependencies&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;spark-core_2.12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;${spark.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;spark-sql_2.12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;${spark.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;hive-jdbc&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;3.1.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;log4j&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;log4j&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;1.2.17&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.spark&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;spark-hive_2.12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;${spark.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;hadoop-client&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;3.2.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;hadoop-common&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;2.7.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.iceberg&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;iceberg-spark&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;${iceberg.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.iceberg&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;iceberg-spark-runtime-3.3_2.12&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;${iceberg.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.avro&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;avro&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;1.10.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;org.apache.parquet&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;parquet-hadoop&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;1.12.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;5.1.37&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/dependencies&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="代码实现">代码实现<a href="#代码实现" class="hash-link" aria-label="Direct link to 代码实现" title="Direct link to 代码实现">​</a></h4>
<ol>
<li>配置Hive catalog</li>
</ol>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">val ss: SparkSession = SparkSession.builder().master(&quot;local[*]&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.appName(&quot;SparkIcebergDemo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hive_prod&quot;, &quot;org.apache.iceberg.spark.SparkCatalog&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hive_prod.type&quot;, &quot;hive&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hive_prod.uri&quot;, &quot;thrift://hadoop2:9083&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.getOrCreate()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>配置Hadoop Catalog</li>
</ol>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">val ss: SparkSession = SparkSession.builder().master(&quot;local[*]&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.appName(&quot;SparkIcebergDemo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod&quot;, &quot;org.apache.iceberg.spark.SparkCatalog&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod.type&quot;, &quot;hadoop&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod.warehouse&quot;, &quot;hdfs://hadoop1:9098/warehouse/sparkiceberg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.getOrCreate()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注意,window需要配置</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">System.setProperty(&quot;hadoop.home.dir&quot;,&quot;D:\\aaa\\hadoop-2.7.6\\hadoop-2.7.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//必须要设置,否则spark会写hive会报HDFS权限问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.setProperty(&quot;HADOOP_USER_NAME&quot;,&quot;root&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>创建表</li>
</ol>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ss.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             |CREATE TABLE catalog_name.default.table1 (id bigint, data string) USING iceberg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           &quot;&quot;&quot;.stripMargin)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dataframe读取表">DataFrame读取表<a href="#dataframe读取表" class="hash-link" aria-label="Direct link to DataFrame读取表" title="Direct link to DataFrame读取表">​</a></h4>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">val ss: SparkSession = SparkSession.builder().master(&quot;local[*]&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.appName(&quot;SparkIcebergDemo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod&quot;, &quot;org.apache.iceberg.spark.SparkCatalog&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod.type&quot;, &quot;hadoop&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod.warehouse&quot;, &quot;hdfs://hadoop1:9098/warehouse/sparkiceberg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.getOrCreate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ss.read.format(&quot;iceberg&quot;).load(&quot;hadoop_prod.xxx.tb4&quot;).show()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>第二种方式</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ss.table(&quot;hadoop_prod.xxx.tb4&quot;).show()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="查询快照信息">查询快照信息<a href="#查询快照信息" class="hash-link" aria-label="Direct link to 查询快照信息" title="Direct link to 查询快照信息">​</a></h4>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> select * from hadoop_prod.xxx.tb4.snapshots</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="查询快照表">查询快照表<a href="#查询快照表" class="hash-link" aria-label="Direct link to 查询快照表" title="Direct link to 查询快照表">​</a></h4>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ss.read.format(&quot;iceberg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.option(&quot;snapshot-id&quot;,6268558238709300005L)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.load(&quot;hadoop_prod.xxx.tb4&quot;).show()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="查询时间戳数据">查询时间戳数据<a href="#查询时间戳数据" class="hash-link" aria-label="Direct link to 查询时间戳数据" title="Direct link to 查询时间戳数据">​</a></h4>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ss.read.format(&quot;iceberg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.option(&quot;as-of-timestamp&quot;,1706231158560L)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.load(&quot;hadoop_prod.xxx.tb4&quot;).show()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="回滚到某个快照">回滚到某个快照<a href="#回滚到某个快照" class="hash-link" aria-label="Direct link to 回滚到某个快照" title="Direct link to 回滚到某个快照">​</a></h4>
<p>Spark DataFrame 不支持回滚到快照<br>Spark3.x后sql的形式可以回滚<br>但是我在测试的时候并没有成功。使用Java API 可以实现快照回滚</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">System.setProperty(&quot;hadoop.home.dir&quot;,&quot;D:\\aaa\\hadoop-2.7.6\\hadoop-2.7.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//必须要设置,否则spark会写hive会报HDFS权限问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.setProperty(&quot;HADOOP_USER_NAME&quot;,&quot;root&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Configuration conf = new Configuration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HadoopCatalog catalog = new HadoopCatalog(conf, &quot;hdfs://hadoop1:9098/warehouse/sparkiceberg&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog.setConf(conf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Table table = catalog.loadTable(TableIdentifier.of(&quot;xxx&quot;, &quot;person_info&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">table.manageSnapshots().rollbackTo(7076891289188705084L).commit();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="合并compact">合并Compact<a href="#合并compact" class="hash-link" aria-label="Direct link to 合并Compact" title="Direct link to 合并Compact">​</a></h4>
<p>合并小文件数据,Iceberg合并小文件时并不会删除被合并的文件，Compact是将小文件合并成大文件并创建新的Snapshot</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//2) 合并小文件数据,Iceberg合并小文件时并不会删除被合并的文件，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Compact是将小文件合并成大文件并创建新的Snapshot。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 如果要删除文件需要通过Expire Snapshots来实现,targetSizeInBytes 指定合并后的每个文件大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Configuration conf = new Configuration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HadoopCatalog catalog = new HadoopCatalog(conf,&quot;hdfs://hadoop1:9098/warehouse/sparkiceberg&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Table table = catalog.loadTable(TableIdentifier.of(&quot;xxx&quot;,&quot;person_info&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SparkSession sparkSession = SparkSession.builder().master(&quot;local[1]&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.appName(&quot;SparkIcebergDemo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod&quot;, &quot;org.apache.iceberg.spark.SparkCatalog&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod.type&quot;, &quot;hadoop&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod.warehouse&quot;, &quot;hdfs://hadoop1:9098/warehouse/sparkiceberg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.getOrCreate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SparkActions sparkActions = SparkActions.get(sparkSession);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RewriteDataFilesSparkAction rewriteDataFilesSparkAction = sparkActions.rewriteDataFiles(table);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rewriteDataFilesSparkAction.execute();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spark-sql-shell">Spark Sql Shell<a href="#spark-sql-shell" class="hash-link" aria-label="Direct link to Spark Sql Shell" title="Direct link to Spark Sql Shell">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="hadoop-catalog">Hadoop Catalog<a href="#hadoop-catalog" class="hash-link" aria-label="Direct link to Hadoop Catalog" title="Direct link to Hadoop Catalog">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/spark-sql --packages org.apache.iceberg:iceberg-spark-runtime-3.2_2.12:1.4.3\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --conf spark.sql.catalog.hadoop_prod=org.apache.iceberg.spark.SparkCatalog \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	  --conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --conf spark.sql.catalog.hadoop_prod.type=hadoop \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --conf spark.sql.catalog.hadoop_prod.warehouse=hdfs://hadoop1:9098/warehouse/sparkiceberg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="读取流程">读取流程<a href="#读取流程" class="hash-link" aria-label="Direct link to 读取流程" title="Direct link to 读取流程">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2024/png/390265/1706105747326-4ba93cce-ab82-440b-904c-95525b02728e.png#averageHue=%23fcd6d2&amp;clientId=u651027a0-ca68-4&amp;from=paste&amp;id=u244dec96&amp;originHeight=533&amp;originWidth=1080&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u21d572fb-827a-4978-86c9-468c20eebc4&amp;title=" alt="" class="img_ev3q"><br>假设我们的表是存储在 Hive 的 MetaStore 里面的，表名为 iteblog，并且数据的组织结构如上如所示。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="查询最新快照的数据">查询最新快照的数据<a href="#查询最新快照的数据" class="hash-link" aria-label="Direct link to 查询最新快照的数据" title="Direct link to 查询最新快照的数据">​</a></h3>
<ul>
<li>通过数据库名和表名，从 Hive 的 MetaStore 里面拿到表的信息。从表的属性里面其实可以拿到 metadata_location 属性，通过这个属性可以拿到 iteblog 表的 Iceberg 的 metadata 相关路径，这个也就是上图步骤①的 /user/iteblog/metadata/2.metadata.json。</li>
<li>解析 /user/iteblog/metadata/2.metadata.json 文件，里面可以拿到当前表的快照 id（current-snapshot-id），以及这张表的所有快照信息，也就是 JOSN 信息里面的 snapshots 数组对应的值。从上图可以看出，当前表有两个快照，id 分别为 1 和 2。快照 1 对应的清单列表文件为 /user/iteblog/metastore/snap-1.avro；快照 2 对应的清单列表文件为 /user/iteblog/metastore/snap-2.avro。</li>
<li>如果我们想读取表的最新快照数据，从 current-snapshot-id 可知，当前最新快照的 ID 等于 2，所以我们只需要解析 /user/iteblog/metastore/snap-2.avro 清单列表文件即可。从上图可以看出，snap-2.avro 这个清单列表文件里面有两个清单文件，分别为 /user/iteblog/metadata/3.avro 和 /user/iteblog/metadata/2.avro。注意，除了清单文件的路径信息，还有 added_data_files_count、existing_data_files_count 以及 deleted_data_files_count 三个属性。Iceberg 其实是根据 deleted_data_files_count 大于 0 来判断对应的清单文件里面是不是被删除的数据。由于上图 /user/iteblog/metadata/2.avro 清单文件的 deleted_data_files_count 大于 0 ，所以读数据的时候就无需读这个清单文件里面对应的数据文件。在这个场景下，读取最新快照数据只需要看下 /user/iteblog/metadata/3.avro 清单文件里面对应的数据文件即可。</li>
<li>这时候 Iceberg 会解析 /user/iteblog/metadata/3.avro 清单文件，里面其实就只有一行数据，也就是 /user/iteblog/data/4.parquet，所以我们读 iteblog 最新的数据其实只需要读 /user/iteblog/data/4.parquet 数据文件就可以了。注意，上面 /user/iteblog/data/2.avro 文件里面对应的内容为</li>
</ul>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;status&quot;:2,&quot;data_file&quot;:{&quot;file_path&quot;:&quot;/user/iteblog/data/3.parquet&quot;}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;status&quot;:2,&quot;data_file&quot;:{&quot;file_path&quot;:&quot;/user/iteblog/data/2.parquet&quot;}}{“status&quot;:2,&quot;data_file&quot;:{&quot;file_path&quot;:&quot;/user/iteblog/data/1.parquet&quot;}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中的 status = 2 代表 DELETED，也就是删除，也印证了读最新快照的数据其实不用读 /user/iteblog/data/2.avro 清单文件的数据文件。而 /user/iteblog/data/3.avro 清单文件里面存储的内容为 <code>{&quot;status&quot;:1,&quot;data_file&quot;:{&quot;file_path&quot;:&quot;/user/iteblog/data/4.parquet&quot;}}，其 status = 1</code>，代表 ADDED，也就是新增的文件，所以得读取。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="查询某个快照的数据">查询某个快照的数据<a href="#查询某个快照的数据" class="hash-link" aria-label="Direct link to 查询某个快照的数据" title="Direct link to 查询某个快照的数据">​</a></h3>
<p>Apache Iceberg 支持查询历史上任何时刻的快照，在查询的时候只需要指定 snapshot-id 属性即可，比如我们想查询上面 snapshot-id 为 1 的数据，可以在 Spark 中这么写：<br><code>spark.read .option(&quot;snapshot-id&quot;, 1L) .format(&quot;iceberg&quot;) .load(&quot;path/to/table&quot;)</code> 下面是读取指定快照的图示<br><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2024/png/390265/1706105948937-3f07fa5e-2bb4-4a69-b94e-67fbb7a18b84.png#averageHue=%23fcdbd8&amp;clientId=u651027a0-ca68-4&amp;from=paste&amp;id=ue6857bc0&amp;originHeight=534&amp;originWidth=1080&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=u90932cf2-9ed6-4b98-a9f7-8987305ea83&amp;title=" alt="" class="img_ev3q"><br>从上图可以看出，和读取最新快照数据不一样的地方是上图中的第三步。由于我们指定了 snapshot-id = 1，所以 Iceberg 会读取上面第二步白色的部分，可以知道，snapshot-id = 1 对应的清单列表文件为 /user/iteblog/metastore/snap-1.avro。这时候读出清单列表里面的文件，其实就只有一行数据，对应的清单文件为 /user/iteblog/metadata/1.avro，其中 added_data_files_count 为 3。<br>下一步我们读取 /user/iteblog/metadata/1.avro 清单文件，可以看到里面有三个数据文件路径，这些数据文件就是 snapshot-id = 1 的数据。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="根据时间戳查看某个快照的数据">根据时间戳查看某个快照的数据<a href="#根据时间戳查看某个快照的数据" class="hash-link" aria-label="Direct link to 根据时间戳查看某个快照的数据" title="Direct link to 根据时间戳查看某个快照的数据">​</a></h3>
<p>Iceberg 还支持通过 as-of-timestamp 参数指定时间戳来读取某个快照的数据。如下所示：</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spark.read.option(&quot;as-of-timestamp&quot;,&quot;12346&quot;).format(&quot;iceberg&quot;).load(&quot;path/to/table&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2024/png/390265/1706106006170-7c0ff5bc-9b1b-4312-8d8c-20885b4cd7be.png#averageHue=%23fdd9d6&amp;clientId=u651027a0-ca68-4&amp;from=paste&amp;id=ud6f371f5&amp;originHeight=580&amp;originWidth=1080&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;taskId=uf47468df-0b14-417f-9448-86f10bd292e&amp;title=" alt="" class="img_ev3q"><br>我们注意上面图中第二步里面的 JSON 数据里面有个 snapshot-log 数组，如下：</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;snapshot-log&quot;:[{&quot;timestamp-ms&quot;:12345,&quot;snapshot-id&quot;:1},{&quot;timestamp-ms&quot;:23456,&quot;snapshot-id&quot;:2}]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>每个列表里面都有个 timestamp-ms 属性和 snapshot-id   属性，并且是按照 timestamp-ms 升序的。在 Iceberg 内部实现中，它会将 as-of-timestamp 指定的时间和 snapshot-log 数组里面每个元素的 timestamp-ms 进行比较，找出最后一个满足 <code>timestamp-ms &lt;= as-of-timestamp</code> 对应的 snapshot-id。<br>由于 as-of-timestamp=12346 比 12345 时间戳大，但是比 23456 小，所以会取 snapshot-id = 1，也就是拿到 snapshot-id = 1 的快照数据。剩下的数据查询步骤和在查询中指定 snapshot-id 是一致的。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ddl">DDL<a href="#ddl" class="hash-link" aria-label="Direct link to DDL" title="Direct link to DDL">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分区表">分区表<a href="#分区表" class="hash-link" aria-label="Direct link to 分区表" title="Direct link to 分区表">​</a></h3>
<p><strong>正常分区表</strong></p>
<div class="language-plsql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plsql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE prod.db.sample (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id bigint,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  data string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  category string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">USING iceberg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITIONED BY (category)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="隐式分区">隐式分区<a href="#隐式分区" class="hash-link" aria-label="Direct link to 隐式分区" title="Direct link to 隐式分区">​</a></h3>
<p><strong>创建隐式分区表</strong></p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ss.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |CREATE TABLE  if  not exists hadoop_prod.xxx.tb3 (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |    id bigint,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |    data string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |    category string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |    ts timestamp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |USING iceberg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |PARTITIONED BY (years(ts))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Supported transformations are:</p>
<ul>
<li>year(ts): partition by year</li>
<li>month(ts): partition by month</li>
<li>day(ts) or date(ts): equivalent to dateint partitioning</li>
<li>hour(ts) or date_hour(ts): equivalent to dateint and hour partitioning</li>
<li>bucket(N, col): partition by hashed value mod N buckets</li>
<li>truncate(L, col): partition by value truncated to L<!-- -->
<ul>
<li>Strings are truncated to the given length</li>
<li>Integers and longs truncate to bins: truncate(10, i) produces partitions 0, 10, 20, 30, …</li>
</ul>
</li>
</ul>
<p><strong>插入隐式分区数据</strong><br>注意需要cast转换数据格式</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        ss</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">sql</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          |insert into hadoop_prod.xxx.tb3 values</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          |(1,&#x27;zhangsan&#x27;,&#x27;sh&#x27;,cast(1706193103 as timestamp)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          |(2,&#x27;lisi&#x27;,&#x27;sz&#x27;,cast(1674657103 as timestamp)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          |(3,&#x27;wangwu&#x27;,&#x27;wh&#x27;,cast(1706193103 as timestamp)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          |(4,&#x27;zhaoliu&#x27;,&#x27;lz&#x27;,cast(1674657103 as timestamp))</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          &quot;&quot;&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stripMargin</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="creat-table-as-select">Creat Table as select<a href="#creat-table-as-select" class="hash-link" aria-label="Direct link to Creat Table as select" title="Direct link to Creat Table as select">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        ss.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |CREATE TABLE  if  not exists hadoop_prod.xxx.tb4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |USING iceberg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |select * from hadoop_prod.xxx.tb3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="写操作">写操作<a href="#写操作" class="hash-link" aria-label="Direct link to 写操作" title="Direct link to 写操作">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mergeinto">MergeINTO<a href="#mergeinto" class="hash-link" aria-label="Direct link to MergeINTO" title="Direct link to MergeINTO">​</a></h3>
<p>Spark 3 添加了对 MERGE INTO 查询的支持，该查询可表达行级更新。Iceberg 通过重写包含需要在 overwrite 提交中更新的行的数据文件来支持 MERGE INTO。建议使用 MERGE INTO，而不是 INSERT OVERWRITE，因为 Iceberg 只能替换受影响的数据文件，而且如果表的分区发生变化，动态覆盖所覆盖的数据也可能发生变化。<br>MERGE INTO 使用来自另一个查询（称为源查询）的一组更新来更新一个表（称为目标表）。使用 ON 子句可以找到目标表中某行的更新，该子句类似于连接条件.<br><strong>语法</strong></p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">MERGE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> prod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">target t   </span><span class="token comment" style="color:#999988;font-style:italic">-- a target table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> s          </span><span class="token comment" style="color:#999988;font-style:italic">-- the source updates</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id                </span><span class="token comment" style="color:#999988;font-style:italic">-- condition to find updates for target rows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>代码实例</strong><br> 注意下面的代码中必须加，否则会报错<code>Exception in thread &quot;main&quot; java.lang.UnsupportedOperationException: MERGE INTO TABLE is not supported temporarily</code>.</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.extensions&quot;, &quot;org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">val spark: SparkSession = SparkSession.builder().master(&quot;local[1]&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.appName(&quot;SparkIcebergDemo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod&quot;, &quot;org.apache.iceberg.spark.SparkCatalog&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.extensions&quot;, &quot;org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod.type&quot;, &quot;hadoop&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.config(&quot;spark.sql.catalog.hadoop_prod.warehouse&quot;, &quot;hdfs://hadoop1:9098/warehouse/sparkiceberg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.getOrCreate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//创建一张表 a ，并插入数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |create table  hadoop_prod.default.a (id int,name string,age int) using iceberg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |insert into hadoop_prod.default.a values (1,&quot;zs&quot;,18),(2,&quot;ls&quot;,19),(3,&quot;ww&quot;,20)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//创建另外一张表b ,并插入数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |create table  hadoop_prod.default.b (id int,name string,age int,tp string) using iceberg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |insert into hadoop_prod.default.b values (1,&quot;zs&quot;,30,&quot;delete&quot;),(2,&quot;李四&quot;,31,&quot;update&quot;),(4,&quot;王五&quot;,32,&quot;add&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//将表b 中与表a中  相同id的数据更新到表a,表a中没有表b中有的id对应数据写入增加到表a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |merge into hadoop_prod.default.a  t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |using (select id,name ,age,tp from hadoop_prod.default.b) t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |on t1.id = t2.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |when matched and t2.tp = &#x27;delete&#x27; then delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |when matched and t2.tp = &#x27;update&#x27; then update set t1.name = t2.name,t1.age = t2.age</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |when not matched then insert (id,name,age) values (t2.id,t2.name,t2.age)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="insert-overwrit">INSERT OVERWRIT<a href="#insert-overwrit" class="hash-link" aria-label="Direct link to INSERT OVERWRIT" title="Direct link to INSERT OVERWRIT">​</a></h3>
<p>INSERT OVERWRITE可以用查询结果替换表中的数据。覆盖是 Iceberg 表的原子操作。<br>INSERT OVERWRITE 替换的分区取决于 Spark 的分区覆盖模式和表的分区情况。 MERGE INTO 只能重写受影响的数据文件，并且具有更容易理解的行为，因此建议代替 INSERT OVERWRITE。<br>Spark默认的覆盖模式是静态的，但是在写入Iceberg表时建议使用动态覆盖模式。静态覆盖模式通过将PARTITION子句转换为过滤器来确定要覆盖表中的哪些分区，但PARTITION子句只能引用表列。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="动态分区覆盖">动态分区覆盖<a href="#动态分区覆盖" class="hash-link" aria-label="Direct link to 动态分区覆盖" title="Direct link to 动态分区覆盖">​</a></h4>
<p>动态覆盖会全量将原有数据覆盖，并将新插入的数据根据Iceberg表分区规则自动分区，类似Hive中的动态分区。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="静态分区覆盖">静态分区覆盖<a href="#静态分区覆盖" class="hash-link" aria-label="Direct link to 静态分区覆盖" title="Direct link to 静态分区覆盖">​</a></h4>
<p>静态覆盖需要在向Iceberg中插入数据时需要手动指定分区，如果当前Iceberg表存在这个分区，那么只有这个分区的数据会被覆盖，其他分区数据不受影响，如果Iceberg表不存在这个分区，那么相当于给Iceberg表增加了个一个分区.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="update">Update<a href="#update" class="hash-link" aria-label="Direct link to Update" title="Direct link to Update">​</a></h3>
<p>Spark3.x+版本支持了update更新数据操作，可以根据匹配的条件进行数据更新操作。操作如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//创建表 delete_tbl ,并加载数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |create table hadoop_prod.default.update_tbl (id int,name string,age int) using iceberg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |&quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |insert into hadoop_prod.default.update_tbl values (1,&quot;zs&quot;,18),(2,&quot;ls&quot;,19),(3,&quot;ww&quot;,20),(4,&quot;ml&quot;,21),(5,&quot;tq&quot;,22),(6,&quot;gb&quot;,23)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过“update”更新表中id小于等于3的数据name列改为“zhangsan”,age列改为30，操作如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//更新 delete_tbl 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |update hadoop_prod.default.update_tbl set name = &#x27;zhangsan&#x27; ,age = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |where id &lt;=3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |select * from hadoop_prod.default.update_tbl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;&quot;&quot;.stripMargin).show()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dataframe-api-写入iceberg表">DataFrame API 写入Iceberg表<a href="#dataframe-api-写入iceberg表" class="hash-link" aria-label="Direct link to DataFrame API 写入Iceberg表" title="Direct link to DataFrame API 写入Iceberg表">​</a></h3>
<p>Spark向Iceberg中写数据时不仅可以使用SQL方式，也可以使用DataFrame Api方式操作Iceberg,建议使用SQL方式操作。<br>DataFrame创建Iceberg表分为创建普通表和分区表，创建分区表时需要指定分区列，分区列可以是多个列。创建表的语法如下:</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">df.write(tbl).create() 相当于 CREATE TABLE AS SELECT ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df.write(tbl).replace() 相当于 REPLACE TABLE AS SELECT ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df.write(tbl).append() 相当于 INSERT INTO ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df.write(tbl).overwritePartitions() 相当于动态 INSERT OVERWRITE ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>具体操作如下</p>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//1.准备数据，使用DataFrame Api 写入Iceberg表及分区表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val nameJsonList = List[String](</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;{\&quot;id\&quot;:1,\&quot;name\&quot;:\&quot;zs\&quot;,\&quot;age\&quot;:18,\&quot;loc\&quot;:\&quot;beijing\&quot;}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;{\&quot;id\&quot;:2,\&quot;name\&quot;:\&quot;ls\&quot;,\&quot;age\&quot;:19,\&quot;loc\&quot;:\&quot;shanghai\&quot;}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;{\&quot;id\&quot;:3,\&quot;name\&quot;:\&quot;ww\&quot;,\&quot;age\&quot;:20,\&quot;loc\&quot;:\&quot;beijing\&quot;}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;{\&quot;id\&quot;:4,\&quot;name\&quot;:\&quot;ml\&quot;,\&quot;age\&quot;:21,\&quot;loc\&quot;:\&quot;shanghai\&quot;}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import spark.implicits._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val df: DataFrame = spark.read.json(nameJsonList.toDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//创建普通表df_tbl1,并将数据写入到Iceberg表，其中DF中的列就是Iceberg表中的列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df.writeTo(&quot;hadoop_prod.default.df_tbl1&quot;).create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//查询表 hadoop_prod.default.df_tbl1 中的数据，并查看数据存储结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.read.table(&quot;hadoop_prod.default.df_tbl1&quot;).show()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//创建分区表df_tbl2,并将数据写入到Iceberg表，其中DF中的列就是Iceberg表中的列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df.sortWithinPartitions($&quot;loc&quot;)//写入分区表，必须按照分区列进行排序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .writeTo(&quot;hadoop_prod.default.df_tbl2&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .partitionedBy($&quot;loc&quot;)//这里可以指定多个列为联合分区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//查询分区表 hadoop_prod.default.df_tbl2 中的数据，并查看数据存储结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark.read.table(&quot;hadoop_prod.default.df_tbl2&quot;).show()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="structured-streaming实时写入iceberg">Structured Streaming实时写入Iceberg<a href="#structured-streaming实时写入iceberg" class="hash-link" aria-label="Direct link to Structured Streaming实时写入Iceberg" title="Direct link to Structured Streaming实时写入Iceberg">​</a></h2>
<div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.TimeUnit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.spark.sql.SparkSession</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.spark.sql.streaming.{Trigger, StreamingQuery}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.spark.sql.{DataFrame, SparkSession}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * Created by Administrator on 2024/1/29 0029.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">object StructuredStreamingSinkIceberg {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def main(args: Array[String]) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.setProperty(&quot;hadoop.home.dir&quot;, &quot;D:\\aaa\\hadoop-2.7.6\\hadoop-2.7.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //必须要设置,否则spark会写hive会报HDFS权限问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;root&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val spark: SparkSession = SparkSession.builder().master(&quot;local[1]&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .appName(&quot;SparkIcebergDemo&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .config(&quot;spark.sql.catalog.hadoop_prod&quot;, &quot;org.apache.iceberg.spark.SparkCatalog&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .config(&quot;spark.sql.extensions&quot;, &quot;org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .config(&quot;spark.sql.catalog.hadoop_prod.type&quot;, &quot;hadoop&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .config(&quot;spark.sql.catalog.hadoop_prod.warehouse&quot;, &quot;hdfs://hadoop1:9098/warehouse/sparkiceberg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .getOrCreate()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spark.sparkContext.setLogLevel(&quot;WARN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import spark.implicits._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //2.创建Iceberg 表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spark.sql(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |create table if not exists hadoop_prod.iceberg_db.iceberg_table (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              | current_day string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              | user_id string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              | page_id string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              | channel string,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              | action string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              |) using iceberg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;&quot;&quot;.stripMargin)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //多个topic 逗号分开</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val topic = &quot;kafka-iceberg-topic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val bootstrapServers = &quot;hadoop1:9092,hadoop2:9092,hadoop3:9092&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //3.读取Kafka读取数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val df = spark.readStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .format(&quot;kafka&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&quot;kafka.bootstrap.servers&quot;, bootstrapServers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&quot;auto.offset.reset&quot;, &quot;earliest&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&quot;group.id&quot;, &quot;iceberg-kafka&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&quot;subscribe&quot;, topic)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .load()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import spark.implicits._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    import org.apache.spark.sql.functions._</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val resDF = df.selectExpr(&quot;CAST(key AS STRING)&quot;, &quot;CAST(value AS STRING)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .as[(String, String)].toDF(&quot;id&quot;, &quot;data&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val transDF: DataFrame = resDF.withColumn(&quot;current_day&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .withColumn(&quot;ts&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .withColumn(&quot;user_id&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .withColumn(&quot;page_id&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(3))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .withColumn(&quot;channel&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .withColumn(&quot;action&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(5))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .select(&quot;current_day&quot;, &quot;user_id&quot;, &quot;page_id&quot;, &quot;channel&quot;, &quot;action&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //结果打印到控制台,Default trigger (runs micro-batch as soon as it can)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*     val query: StreamingQuery = transDF.writeStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .outputMode(&quot;append&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .format(&quot;console&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .option(&quot;checkpointLocation&quot;, &quot;/tmp/checkpoint1/wordocunt8&quot;) // 设置 checkpoint 目录以支持 Exactly-Once 语义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .trigger(Trigger.ProcessingTime(&quot;2 second&quot;)) // 可以设置触发器，这里每秒触发一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .start()*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val query = transDF.writeStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .format(&quot;iceberg&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .outputMode(&quot;append&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //每分钟触发一次Trigger.ProcessingTime(1, TimeUnit.MINUTES)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //每10s 触发一次 Trigger.ProcessingTime(1, TimeUnit.MINUTES)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .trigger(Trigger.ProcessingTime(10, TimeUnit.SECONDS))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&quot;path&quot;, &quot;hadoop_prod.iceberg_db.iceberg_table&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&quot;fanout-enabled&quot;, &quot;true&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .option(&quot;checkpointLocation&quot;, &quot;/tmp/checkpoint1/wordocunt8&quot;) // 设置 checkpoint 目录以支持 Exactly-Once 语义</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .start()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    query.awaitTermination()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="iceberg集成flink">Iceberg集成Flink<a href="#iceberg集成flink" class="hash-link" aria-label="Direct link to Iceberg集成Flink" title="Direct link to Iceberg集成Flink">​</a></h2>
<blockquote>
<p>Flink 版本1.16.2, Iceberg 版本1.4.3</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="maven-pom">Maven Pom<a href="#maven-pom" class="hash-link" aria-label="Direct link to Maven Pom" title="Direct link to Maven Pom">​</a></h3>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token prolog" style="color:#999988;font-style:italic">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">project</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">xmlns</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://maven.apache.org/POM/4.0.0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xmlns:</span><span class="token tag attr-name" style="color:#00a4db">xsi</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">xsi:</span><span class="token tag attr-name" style="color:#00a4db">schemaLocation</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">modelVersion</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">4.0.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">modelVersion</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.daiyutage</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Flink-Iceberg</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.0-SNAPSHOT</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">properties</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">maven.compiler.source</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">8</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">maven.compiler.source</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">maven.compiler.target</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">8</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">maven.compiler.target</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">project.build.sourceEncoding</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">UTF-8</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">project.build.sourceEncoding</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">flink-version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.16.2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">flink-version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">properties</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependencies</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-core</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink-version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-clients</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink-version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-streaming-java</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink-version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-table-planner_2.12</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink-version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-connector-kafka</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink-version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flink</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flink-runtime-web</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${flink-version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!--        &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    &lt;groupId&gt;org.apache.iceberg&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    &lt;artifactId&gt;iceberg-flink&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    &lt;version&gt;1.4.3&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  &lt;/dependency&gt;--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.iceberg</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">iceberg-flink-runtime-1.16</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.4.3</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.hadoop</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">hadoop-common</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!--&lt;version&gt;2.7.2&lt;/version&gt;--&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3.2.2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.hadoop</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">hadoop-client</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3.2.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependencies</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">project</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建表-1">创建表<a href="#创建表-1" class="hash-link" aria-label="Direct link to 创建表" title="Direct link to 创建表">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.daiyutage.flink.iceberg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.functions.MapFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.EnvironmentSettings;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.TableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.data.RowData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.data.StringData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.flink.TableLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.flink.source.FlinkSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Created by Administrator on 2024/1/31 0031.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FlinkIcebergExample2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 使用Flink SQL 创建Iceberg表,并写入数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;hadoop.home.dir&quot;, &quot;D:\\aaa\\hadoop-2.7.6\\hadoop-2.7.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //必须要设置,否则spark会写hive会报HDFS权限问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;root&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tblEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.创建Catalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tblEnv.executeSql(&quot;CREATE CATALOG hadoop_iceberg WITH (&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;type&#x27;=&#x27;iceberg&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;catalog-type&#x27;=&#x27;hadoop&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;warehouse&#x27;=&#x27;hdfs://hadoop1:9098/warehouse/flinkiceberg&#x27;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.使用当前Catalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tblEnv.useCatalog(&quot;hadoop_iceberg&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.创建数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tblEnv.executeSql(&quot;use database iceberg_db&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //4.使用数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tblEnv.useDatabase(&quot;iceberg_db&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //5.创建iceberg表 flink_iceberg_tbl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tblEnv.executeSql(&quot;create table hadoop_iceberg.iceberg_db.flink_iceberg_tbl1(id int,name string,age int,loc string) partitioned by (loc)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //6.写入数据到表 flink_iceberg_tbl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               tblEnv.executeSql(&quot;insert into hadoop_iceberg.iceberg_db.flink_iceberg_tbl1 values (1,&#x27;zs&#x27;,18,&#x27;beijing&#x27;),(2,&#x27;ls&#x27;,19,&#x27;shanghai&#x27;),(3,&#x27;ww&#x27;,20,&#x27;guangzhou&#x27;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="读取表">读取表<a href="#读取表" class="hash-link" aria-label="Direct link to 读取表" title="Direct link to 读取表">​</a></h3>
<p>Flink可以批量读取表或者是流式读取表。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.daiyutage.flink.iceberg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.functions.MapFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.data.RowData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.data.StringData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.flink.TableLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.flink.source.FlinkSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Created by Administrator on 2024/1/31 0031.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FlinkIcebergExample1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 使用Flink DataStream API 批量(流失)读取Iceberg表数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;hadoop.home.dir&quot;, &quot;D:\\aaa\\hadoop-2.7.6\\hadoop-2.7.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //必须要设置,否则spark会写hive会报HDFS权限问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;root&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TableLoader tableLoader = TableLoader.fromHadoopTable(&quot;hdfs://hadoop1:9098/warehouse/flinkiceberg/iceberg_db/flink_iceberg_tbl2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStream&lt;org.apache.flink.table.data.RowData&gt; dataStream = FlinkSource.forRowData()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .env(env)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .tableLoader(tableLoader)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .streaming(true) //true为流式读取,false为批量一次读取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         *         val transDF: DataFrame = resDF.withColumn(&quot;current_day&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(0))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         .withColumn(&quot;ts&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         .withColumn(&quot;user_id&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(2))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         .withColumn(&quot;page_id&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(3))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         .withColumn(&quot;channel&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(4))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         .withColumn(&quot;action&quot;, split(col(&quot;data&quot;), &quot;\t&quot;)(5))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         .select(&quot;current_day&quot;, &quot;user_id&quot;, &quot;page_id&quot;, &quot;channel&quot;, &quot;action&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Print all records to stdout.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataStream.map(new MapFunction&lt;RowData, String&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public String map(RowData rowData) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Integer current_day = rowData.getInt(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StringData user_id = rowData.getString(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Integer age = rowData.getInt(2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                StringData channel = rowData.getString(3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return current_day + &quot;,&quot; + user_id + &quot;,&quot; + age + &quot;,&quot; + channel ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }).print();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Submit and execute this batch read job.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.execute(&quot;Test Iceberg Batch Read&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实时写入表">实时写入表<a href="#实时写入表" class="hash-link" aria-label="Direct link to 实时写入表" title="Direct link to 实时写入表">​</a></h3>
<p>消费Kafka数据，然后实时写入Iceberg表。注意，必须要开启checkpoint机制，否则不会commit数据,写入之后是没有效果的。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.daiyutage.flink.iceberg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.google.common.collect.ImmutableMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.eventtime.WatermarkStrategy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.functions.MapFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.api.common.serialization.SimpleStringSchema;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.configuration.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.configuration.RestOptions;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.connector.kafka.source.KafkaSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.connector.kafka.source.enumerator.initializer.OffsetsInitializer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.functions.sink.PrintSinkFunction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.data.GenericRowData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.data.RowData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.data.StringData;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.catalog.TableIdentifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.flink.TableLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.flink.sink.FlinkSink;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.hadoop.HadoopCatalog;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.iceberg.types.Types;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Created by Administrator on 2024/2/3 0003.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class KafkaToIceberg {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;hadoop.home.dir&quot;, &quot;D:\\aaa\\hadoop-2.7.6\\hadoop-2.7.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //必须要设置,否则spark会写hive会报HDFS权限问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;root&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configuration conf = new Configuration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //设置WebUI绑定的本地端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        conf.setString(RestOptions.BIND_PORT, &quot;8086&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment(conf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironmentWithWebUI(conf);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //        StreamTableEnvironment tblEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(2000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.getCheckpointConfig().setCheckpointStorage(&quot;file:///D:\\Program\\Flink-Project\\Flink-Iceberg\\checkpoint&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.disableOperatorChaining();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String bootStrapServer = &quot;hadoop1:9092,hadoop2:9092,hadoop3:9092&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        KafkaSource&lt;String&gt; kafkaSource = KafkaSource.&lt;String&gt;builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setBootstrapServers(bootStrapServer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setTopics(&quot;mytopic&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setGroupId(&quot;my-group-id-1&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setStartingOffsets(OffsetsInitializer.latest())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setValueOnlyDeserializer(new SimpleStringSchema())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataStreamSource&lt;String&gt; kafkaDS = env.fromSource(kafkaSource, WatermarkStrategy.noWatermarks(), &quot;kafkaSource&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SingleOutputStreamOperator&lt;RowData&gt; mapDS = kafkaDS.map(new MapFunction&lt;String, RowData&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public RowData map(String line) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String[] split = line.split(&quot;,&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                GenericRowData row = new GenericRowData(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                row.setField(0, Integer.valueOf(split[0]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                row.setField(1, StringData.fromString(split[1]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                row.setField(2, Integer.valueOf(split[2]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                row.setField(3, StringData.fromString(split[3]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return row;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org.apache.hadoop.conf.Configuration config = new org.apache.hadoop.conf.Configuration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HadoopCatalog catalog = new HadoopCatalog(config, &quot;hdfs://hadoop1:9098/warehouse/flinkiceberg&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //配置iceberg 库名和表名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TableIdentifier name = TableIdentifier.of(&quot;icebergdb&quot;, &quot;flink_iceberg_tbl1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //创建Icebeng表Schema</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Schema schema = new Schema(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Types.NestedField.required(1, &quot;id&quot;, Types.IntegerType.get()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Types.NestedField.required(2, &quot;nane&quot;, Types.StringType.get()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Types.NestedField.required(3, &quot;age&quot;, Types.IntegerType.get()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Types.NestedField.required(4, &quot;loc&quot;, Types.StringType.get()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //如果有分区指定对应分区，这里“loc”列为分区列，可以指定unpartitioned 方法不设置表分区</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //        PartitionSpec spec = PartitionSpec.unpartitioned();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PartitionSpec spec = PartitionSpec.builderFor(schema).identity(&quot;loc&quot;).build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, String&gt; props =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ImmutableMap.of(TableProperties.DEFAULT_FILE_FORMAT, FileFormat.PARQUET.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Table table = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 通过catalog判断表是否存在，不存在就创建，存在就加载</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!catalog.tableExists(name)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            table = catalog.createTable(name, schema, spec, props);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            table = catalog.loadTable(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mapDS.addSink(new PrintSinkFunction&lt;&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TableLoader tableLoader = TableLoader.fromHadoopTable(&quot;hdfs://hadoop1:9098/warehouse/flinkiceberg/iceberg_db/flink_iceberg_tbl1&quot;, config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //5.通过DataStream Api 向Iceberg中写入数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FlinkSink.forRowData(mapDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //这个 .table 也可以不写，指定tableLoader 对应的路径就可以。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //                .table(table)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .tableLoader(tableLoader)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //默认为false,追加数据。如果设置为true 就是覆盖数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .overwrite(false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .append();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kafkaDS.name(&quot;KafkaSource&quot;).addSink(new PrintSinkFunction&lt;&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Kafka样例数据</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@node1 bin]#bin//kafka-console-producer.sh  --topic mytopic --broker-list hadoop1:9092,hadoop2:9092,hadoop3:9092</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1,zs,18,beijing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2,ls,19,shanghai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3,ww,20,beijing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4,ml,21,shanghai</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sql-api-操作">SQL API 操作<a href="#sql-api-操作" class="hash-link" aria-label="Direct link to SQL API 操作" title="Direct link to SQL API 操作">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="批量读取表">批量读取表<a href="#批量读取表" class="hash-link" aria-label="Direct link to 批量读取表" title="Direct link to 批量读取表">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">System.setProperty(&quot;hadoop.home.dir&quot;, &quot;D:\\aaa\\hadoop-2.7.6\\hadoop-2.7.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//必须要设置,否则spark会写hive会报HDFS权限问题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;root&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StreamTableEnvironment tblEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">env.enableCheckpointing(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//1.创建Catalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tblEnv.executeSql(&quot;CREATE CATALOG hadoop_iceberg WITH (&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;&#x27;type&#x27;=&#x27;iceberg&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;&#x27;catalog-type&#x27;=&#x27;hadoop&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  &quot;&#x27;warehouse&#x27;=&#x27;hdfs://hadoop1:9098/warehouse/flinkiceberg&#x27;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TableResult tableResult = tblEnv.executeSql(&quot;select * from hadoop_iceberg.iceberg_db.flink_iceberg_tbl2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tableResult.print();;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="实时读取表">实时读取表<a href="#实时读取表" class="hash-link" aria-label="Direct link to 实时读取表" title="Direct link to 实时读取表">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.daiyutage.flink.iceberg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.configuration.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.TableResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Created by Administrator on 2024/2/3 0003.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FlinkSqlIceberg2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tblEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configuration configuration = tblEnv.getConfig().getConfiguration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 支持SQL语法中的 OPTIONS 选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configuration.setBoolean(&quot;table.dynamic-table-options.enabled&quot;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.创建Catalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tblEnv.executeSql(&quot;CREATE CATALOG hadoop_iceberg WITH (&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;type&#x27;=&#x27;iceberg&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;catalog-type&#x27;=&#x27;hadoop&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;warehouse&#x27;=&#x27;hdfs://hadoop1:9098/warehouse/flinkiceberg&#x27;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //2.从Iceberg表当前快照读取所有数据，并继续增量读取数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // streaming指定为true支持实时读取数据，monitor_interval 监控数据的间隔，默认1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TableResult tableResult = tblEnv.executeSql(&quot;select * from hadoop_iceberg.iceberg_db.flink_iceberg_tbl2 /*+ OPTIONS(&#x27;streaming&#x27;=&#x27;true&#x27;, &#x27;monitor-interval&#x27;=&#x27;1s&#x27;)*/&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableResult.print();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="读取kafka写入表">读取Kafka写入表<a href="#读取kafka写入表" class="hash-link" aria-label="Direct link to 读取Kafka写入表" title="Direct link to 读取Kafka写入表">​</a></h4>
<p>实时消费Kafka数据，然后写入Iceberg表</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.daiyutage.flink.iceberg;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.configuration.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.TableResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flink.table.api.bridge.java.StreamTableEnvironment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Created by Administrator on 2024/2/3 0003.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FlinkSqlToIceberg {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 实时消费kafka数据写入Iceberg表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StreamTableEnvironment tblEnv = StreamTableEnvironment.create(env);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        env.enableCheckpointing(5000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Configuration configuration = tblEnv.getConfig().getConfiguration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 支持SQL语法中的 OPTIONS 选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configuration.setBoolean(&quot;table.dynamic-table-options.enabled&quot;, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1.创建Catalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tblEnv.executeSql(&quot;CREATE CATALOG hadoop_iceberg WITH (&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;type&#x27;=&#x27;iceberg&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;catalog-type&#x27;=&#x27;hadoop&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;&#x27;warehouse&#x27;=&#x27;hdfs://hadoop1:9098/warehouse/flinkiceberg&#x27;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //3.创建 Kafka Connector,连接消费Kafka中数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tblEnv.executeSql(&quot;create table kafka_input_table(&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; id int,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; name varchar,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; age int,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; loc varchar&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;) with (&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; &#x27;connector&#x27; = &#x27;kafka&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; &#x27;topic&#x27; = &#x27;mytopic&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; &#x27;properties.bootstrap.servers&#x27;=&#x27;hadoop1:9092,hadoop2:9092,hadoop3:9092&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; &#x27;scan.startup.mode&#x27;=&#x27;latest-offset&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; &#x27;properties.group.id&#x27; = &#x27;my-group-id&#x27;,&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot; &#x27;format&#x27; = &#x27;csv&#x27;&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          &quot;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TableResult tableResult = tblEnv.executeSql(&quot;select * from kafka_input_table&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tableResult.print();;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/数据仓库/数仓面试题"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">数仓面试题</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#iceberg集成hive" class="table-of-contents__link toc-highlight">Iceberg集成Hive</a><ul><li><a href="#集成hive配置" class="table-of-contents__link toc-highlight">集成Hive配置</a></li><li><a href="#创建表" class="table-of-contents__link toc-highlight">创建表</a></li></ul></li><li><a href="#iceberg集成spark" class="table-of-contents__link toc-highlight">Iceberg集成Spark</a><ul><li><a href="#spark代码" class="table-of-contents__link toc-highlight">Spark代码</a></li><li><a href="#spark-sql-shell" class="table-of-contents__link toc-highlight">Spark Sql Shell</a></li></ul></li><li><a href="#读取流程" class="table-of-contents__link toc-highlight">读取流程</a><ul><li><a href="#查询最新快照的数据" class="table-of-contents__link toc-highlight">查询最新快照的数据</a></li><li><a href="#查询某个快照的数据" class="table-of-contents__link toc-highlight">查询某个快照的数据</a></li><li><a href="#根据时间戳查看某个快照的数据" class="table-of-contents__link toc-highlight">根据时间戳查看某个快照的数据</a></li></ul></li><li><a href="#ddl" class="table-of-contents__link toc-highlight">DDL</a><ul><li><a href="#分区表" class="table-of-contents__link toc-highlight">分区表</a></li><li><a href="#隐式分区" class="table-of-contents__link toc-highlight">隐式分区</a></li><li><a href="#creat-table-as-select" class="table-of-contents__link toc-highlight">Creat Table as select</a></li></ul></li><li><a href="#写操作" class="table-of-contents__link toc-highlight">写操作</a><ul><li><a href="#mergeinto" class="table-of-contents__link toc-highlight">MergeINTO</a></li><li><a href="#insert-overwrit" class="table-of-contents__link toc-highlight">INSERT OVERWRIT</a></li><li><a href="#update" class="table-of-contents__link toc-highlight">Update</a></li><li><a href="#dataframe-api-写入iceberg表" class="table-of-contents__link toc-highlight">DataFrame API 写入Iceberg表</a></li></ul></li><li><a href="#structured-streaming实时写入iceberg" class="table-of-contents__link toc-highlight">Structured Streaming实时写入Iceberg</a></li><li><a href="#iceberg集成flink" class="table-of-contents__link toc-highlight">Iceberg集成Flink</a><ul><li><a href="#maven-pom" class="table-of-contents__link toc-highlight">Maven Pom</a></li><li><a href="#创建表-1" class="table-of-contents__link toc-highlight">创建表</a></li><li><a href="#读取表" class="table-of-contents__link toc-highlight">读取表</a></li><li><a href="#实时写入表" class="table-of-contents__link toc-highlight">实时写入表</a></li><li><a href="#sql-api-操作" class="table-of-contents__link toc-highlight">SQL API 操作</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>