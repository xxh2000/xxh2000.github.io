<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Hive/Hive实践" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Hive实践 | 大数据Guide</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/docs/Hive/Hive实践"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Hive实践 | 大数据Guide"><meta data-rh="true" name="description" content="排名函数"><meta data-rh="true" property="og:description" content="排名函数"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/docs/Hive/Hive实践"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/Hive/Hive实践" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/Hive/Hive实践" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="大数据Guide RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="大数据Guide Atom Feed"><link rel="stylesheet" href="/assets/css/styles.69f2a557.css">
<script src="/assets/js/runtime~main.9ccc24a5.js" defer="defer"></script>
<script src="/assets/js/main.901e4aca.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">大数据Guide</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Flink/Flink SQL JOIN原理">大数据</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Flink/Flink SQL JOIN原理">Flink</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Hadoop/Hadoop实践">Hadoop</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Hive/Hive调优">Hive</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hive/Hive调优">Hive调优</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Hive/Hive实践">Hive实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hive/Hive经典面试SQL">Hive经典面试SQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hive/hive面试题">hive面试题</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Kafka/Kafka实践">Kafka</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/OLAP/Clickhouse/Clickhouse存算分离">OLAP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Spark/Spark面试题1">Spark</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Zookeeper/Zookeeper面试题">Zookeeper</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/其他/Flume面试题">其他</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/数据仓库/数仓架构建设方法论">数据仓库</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/数据湖/Iceberg/Iceberg实践">数据湖</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Hive</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Hive实践</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Hive实践</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="排名函数">排名函数<a href="#排名函数" class="hash-link" aria-label="Direct link to 排名函数" title="Direct link to 排名函数">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="row_number">ROW_NUMBER()<a href="#row_number" class="hash-link" aria-label="Direct link to ROW_NUMBER()" title="Direct link to ROW_NUMBER()">​</a></h3>
<p>给定一个分区内的行一个唯一的整数排名，按照记录的排序顺序。示例：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  column1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  column2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ROW_NUMBER() OVER (PARTITION BY partition_column ORDER BY order_column) AS rank</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  table_name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rank">RANK()<a href="#rank" class="hash-link" aria-label="Direct link to RANK()" title="Direct link to RANK()">​</a></h3>
<p>为分区内的行分配一个排名，如果有相等的值，则将它们分配相同的排名，有相同排名，但会跳过占用的排名。示例：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  column1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  column2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RANK() OVER (PARTITION BY partition_column ORDER BY order_column) AS rank</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  table_name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dense_rank">DENSE_RANK()<a href="#dense_rank" class="hash-link" aria-label="Direct link to DENSE_RANK()" title="Direct link to DENSE_RANK()">​</a></h3>
<p>DENSE意思为稠密的，即序号是连续的。为分区内的行分配一个排名，如果有相等的值，则将它们分配相同的排名，但不跳过后续的排名。示例：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  column1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  column2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DENSE_RANK() OVER (PARTITION BY partition_column ORDER BY order_column) AS rank</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  table_name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="窗口函数">窗口函数<a href="#窗口函数" class="hash-link" aria-label="Direct link to 窗口函数" title="Direct link to 窗口函数">​</a></h2>
<p>可参考<a href="https://www.baispace.cn/article/hive-knowledge-window-function.html" target="_blank" rel="noopener noreferrer">https://www.baispace.cn/article/hive-knowledge-window-function.html</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="定义">定义<a href="#定义" class="hash-link" aria-label="Direct link to 定义" title="Direct link to 定义">​</a></h3>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Function (arg1,..., argn) OVER ([PARTITION BY &lt;...&gt;] [ORDER BY &lt;....&gt;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Function (arg1,..., argn) 可以是下面的函数：</p>
<ul>
<li>Aggregate Functions: 聚合函数,比如：sum(...)、 max(...)、min(...)、avg(...)等.</li>
<li>Sort Functions: 数据排序函数, 比如 ：rank(...)、row_number(...)等.</li>
<li>Analytics Functions: 统计和比较函数, 比如：lead(...)、lag(...)、 first_value(...)等.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="窗口边界">窗口边界<a href="#窗口边界" class="hash-link" aria-label="Direct link to 窗口边界" title="Direct link to 窗口边界">​</a></h3>
<table><thead><tr><th>preceding</th><th>往前</th></tr></thead><tbody><tr><td>following</td><td>往后</td></tr><tr><td>current row</td><td>当前行</td></tr><tr><td>unbounded</td><td>起点</td></tr><tr><td>unbounded preceding</td><td>从前面的起点</td></tr><tr><td>unbounded following</td><td>到后面的终点</td></tr><tr><td><img decoding="async" loading="lazy" alt="img_9.png" src="/assets/images/img_9-3eb4cb838e50f077c45da01e9479e4d5.png" width="824" height="320" class="img_ev3q"></td><td></td></tr></tbody></table>
<ol>
<li>如果不指定 PARTITION BY，则不对数据进行分区，换句话说，所有数据看作同一个分区；</li>
<li>如果不指定 ORDER BY，则不对各分区做排序，通常用于那些顺序无关的窗口函数，例如 SUM()</li>
<li>如果不指定窗口子句，则默认采用以下的窗口定义：<br>a、<strong>若不指定 ORDER BY，默认使用分区内所有行 ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</strong>.<br>b、若指定了 ORDER BY，默认使 用分区内第一行到当前值 ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW.</li>
</ol>
<p><strong>计算过程</strong></p>
<ul>
<li>按窗口定义，将所有输入数据分区、再排序（如果需要的话）</li>
<li>对每一行数据，计算它的窗口范围</li>
<li>将窗口内的行集合输入窗口函数，计算结果填入当前行<!-- -->
<a name="Wc3cT"></a>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="窗口聚合函数">窗口聚合函数<a href="#窗口聚合函数" class="hash-link" aria-label="Direct link to 窗口聚合函数" title="Direct link to 窗口聚合函数">​</a></h3>
<table><thead><tr><th>AVG()</th><th>参数类型为DECIMAL的返回类型为DECIMAL，其他为DOUBLE</th><th>AVG 窗口函数返回输入表达式值的平均值，忽略 NULL 值。</th></tr></thead><tbody><tr><td>COUNT()</td><td>BIGINT</td><td>COUNT 窗口函数计算输入行数。 COUNT(*) 计算目标表中的所有行，包括Null值；COUNT(expression) 计算特定列或表达式中具有非 NULL 值的行数。</td></tr><tr><td>MAX()</td><td>与传参类型一致</td><td>MAX窗口函数返回表达式在所有输入值中的最大值，忽略 NULL 值。</td></tr><tr><td>MIN()</td><td>与传参类型一致</td><td>MIN窗口函数返回表达式在所有输入值中的最小值，忽略 NULL 值。</td></tr><tr><td>SUM()</td><td>针对传参类型为DECIMAL的，返回类型一致；除此之外的浮点型为DOUBLE；传参类型为整数类型的，返回类型为BIGINT</td><td>SUM窗口函数返回所有输入值的表达式</td></tr></tbody></table>
<a name="HR7Y5"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="窗口排名函数">窗口排名函数<a href="#窗口排名函数" class="hash-link" aria-label="Direct link to 窗口排名函数" title="Direct link to 窗口排名函数">​</a></h3>
<table><thead><tr><th>ROW_NUMBER()</th><th>BIGINT</th><th>根据具体的分组和排序，为每行数据生成一个起始值等于1的唯一序列数</th></tr></thead><tbody><tr><td>RANK()</td><td>BIGINT</td><td>对组中的数据进行排名，如果名次相同，则排名也相同，但是下一个名次的排名序号会出现不连续。</td></tr><tr><td>DENSE_RANK() dense是稠密的意思，可以引申记忆</td><td>BIGINT</td><td>dense_rank函数的功能与rank函数类似，dense_rank函数在生成序号时是连续的，而rank函数生成的序号有可能不连续。当出现名次相同时，则排名序号也相同。而下一个排名的序号与上一个排名序号是连续的。</td></tr><tr><td>PERCENT_RANK()</td><td>DOUBLE</td><td>计算给定行的百分比排名。可以用来计算超过了百分之多少的人;排名计算公式为：(当前行的rank值-1)/(分组内的总行数-1)</td></tr><tr><td>CUME_DIST()</td><td>DOUBLE</td><td>计算某个窗口或分区中某个值的累积分布。假定升序排序，则使用以下公式确定累积分布：小于等于当前值x的行数 / 窗口或partition分区内的总行数。其中，x 等于 order by 子句中指定的列的当前行中的值</td></tr><tr><td>NTILE()</td><td>INT</td><td>ntile 函数用于将分组数据按照顺序切分成n组，并返回当前切片值。如果切片不均匀，默认增加第一个切片的分布。它把有序的数据集合「平均分配」到指定的数量（n）个桶中, 将桶号分配给每一行。如果不能平均分配，则优先分配较小编号的桶，并且各个桶中能放的行数最多相差 1。</td></tr></tbody></table>
<a name="baUgE"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="值窗口函数">值窗口函数<a href="#值窗口函数" class="hash-link" aria-label="Direct link to 值窗口函数" title="Direct link to 值窗口函数">​</a></h3>
<table><thead><tr><th>LAG()</th><th>与lead相反，用于统计窗口内往上第n行值。第一个参数为列名，第二个参数为往上第n行（可选，默认为1），第三个参数为默认值（当往上第n行为NULL时候，取默认值，如不指定，则为NULL.</th></tr></thead><tbody><tr><td>LEAD()</td><td>用于统计窗口内往下第n行值。第一个参数为列名，第二个参数为往下第n行（可选，默认为1），第三个参数为默认值（当往下第n行为NULL时候，取默认值，如不指定，则为NULL.</td></tr><tr><td>FIRST_VALUE</td><td>取分组内排序后，截止到当前行，第一个值</td></tr><tr><td>LAST_VALUE</td><td>取分组内排序后，截止到当前行，最后一个值</td></tr></tbody></table>
<p>注意: last_value默认的窗口是 RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</p>
<a name="wRkDd"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="表生成函数">表生成函数<a href="#表生成函数" class="hash-link" aria-label="Direct link to 表生成函数" title="Direct link to 表生成函数">​</a></h2>
<a name="t1QlT"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="explode">Explode<a href="#explode" class="hash-link" aria-label="Direct link to Explode" title="Direct link to Explode">​</a></h3>
<div class="language-plsql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plsql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EXPLODE(array|map|struct)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>explode(col)：将hive一列中复杂的array或者map结构拆分成多行。</strong></p>
<ul>
<li>explode(ARRAY):数组的每个元素生成一行</li>
<li>explode(MAP) map中每个key-value对，生成一行，key为一列，value为一列<!-- -->
<a name="LpHyJ"></a>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="posexplode">posexplode<a href="#posexplode" class="hash-link" aria-label="Direct link to posexplode" title="Direct link to posexplode">​</a></h3>
<p><strong>posexplode()<strong>函数类似于</strong>explode()</strong>，但额外返回元素的位置。</p>
<div class="language-plsql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plsql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  pos,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exploded_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  example_array_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LATERAL VIEW POSEXPLODE(values) exploded_table AS pos, exploded_value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="XmjUM"></a>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="json_tuple">json_tuple<a href="#json_tuple" class="hash-link" aria-label="Direct link to json_tuple" title="Direct link to json_tuple">​</a></h3>
<p><strong>json_tuple()</strong> 函数用于解析JSON格式的字符串，并将其中的字段提取为列。</p>
<div class="language-plsql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plsql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  age</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  example_json_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LATERAL VIEW JSON_TUPLE(json_data, &#x27;name&#x27;, &#x27;age&#x27;) exploded_table AS name, age;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<a name="FDYyF"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lateral-view侧视图">LATERAL VIEW侧视图<a href="#lateral-view侧视图" class="hash-link" aria-label="Direct link to LATERAL VIEW侧视图" title="Direct link to LATERAL VIEW侧视图">​</a></h2>
<div class="language-plsql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plsql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LATERAL VIEW udtf(expression) tableAlias AS columnAlias</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>LATERAL VIEW</code> 是用于将复杂数据类型（如数组、Map、结构体等）展开成表格形式的操作符。它通常与内置  的函数一起使用，以便在查询过程中处理这些复杂数据类型
。用于和split, explode等UDTF一起使用，它能够将一列数据拆成多行数据，在此基础上可以对拆分后的数据进行聚合.
Lateral View主要解决在select使用UDTF做查询的过程中查询只能包含单个UDTF，不能包含其它字段以及多个UDTF的情况（不能添加额外的select列的问题）。
Lateral View其实就是用来和想类似explode这种UDTF函数联用的，lateral view会将UDTF生成的结果放到一个虚拟表中，然后这个虚拟表会和输入行进行join来达到连接UDTF外的select字段的目的。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="排序">排序<a href="#排序" class="hash-link" aria-label="Direct link to 排序" title="Direct link to 排序">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="order-by">Order By<a href="#order-by" class="hash-link" aria-label="Direct link to Order By" title="Direct link to Order By">​</a></h3>
<p>全局排序。在 Hive 中，ORDER BY 保证数据的全局有序，为此将所有的数据发送到一个 Reducer 中。因为只有一个 Reducer，所以当输入规模较大时，需要较长的计算时间。Hive 中的 ORDER BY 语法与 SQL 中 ORDER BY 的语法相似，按照某一项或者几项排序输出，可以指定是升序或者是降序排序。</p>
<p><strong>limit限制</strong></p>
<p>在严格模式下，即 hive.mapred.mode = strict，ORDER BY 子句后面必须跟一个 LIMIT 子句。如果将 hive.mapred.mode 设置为 nonstrict，可以不用 LIMIT 子句。原因是为了实现所有数据的全局有序，只能使用一个 reducer 来对最终输出进行排序。如果输出中的行数太大，单个 Reducer 可能需要很长时间才能完成。如果在严格模式不指定 LIMIT 子句，会报错。SemanticException 1:106 Order by-s without limit are disabled for safety reasons</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sort-by">Sort By<a href="#sort-by" class="hash-link" aria-label="Direct link to Sort By" title="Direct link to Sort By">​</a></h3>
<p>分区内排序。不是全局排序，其在数据进入reducer前完成排序，也就是说它会在数据进入reduce之前为每个reducer都产生一个排序后的文件。因此，如果用sort by进行排序，并且设置mapreduce.job.reduces&gt;1，则sort by只保证每个reducer的输出有序，不保证全局有序。
Hive 支持 SORT BY，它对每个 reducer 的数据进行排序。
order by和sort by的区别在于,<strong>前者保证输出中的总顺序，而后者仅保证 reducer 内行的排序。如果有多个 reducer,sort by可能会给出部分有序的最终结果</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="distribute-by">distribute by<a href="#distribute-by" class="hash-link" aria-label="Direct link to distribute by" title="Direct link to distribute by">​</a></h3>
<p>数据分发。distribute by是控制在map端如何拆分数据给reduce端的。类似于MapReduce中分区partationer对数据进行分区。hive会根据distribute by后面列，将数据分发给对应的reducer，默认是采用hash算法+取余数的方式。在Mapreduce程序中，进行HashPartition的key是读取输入文件的每行的一个起始位置(单位是字节)，“值”是本行的文本内容。
sort by为每个reduce产生一个排序文件，在有些情况下，你需要控制某写特定的行应该到哪个reducer，这通常是为了进行后续的聚集操作。distribute by刚好可以做这件事。因此，distribute by经常和sort by配合使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-by">cluster by<a href="#cluster-by" class="hash-link" aria-label="Direct link to cluster by" title="Direct link to cluster by">​</a></h3>
<blockquote>
<p>cluster= distribute by + sort by 同一字段 且asc 升序</p>
</blockquote>
<p>cluster by除了具有distribute by的功能外还兼具sort by的功能。但是排序只能是升序排序，不能 指定排序规则为ASC或者DESC。
当分区字段和排序字段相同cluster by可以简化distribute by+sort by 的SQL 写法，也就是说当distribute by和sort by 字段相同时，可以使用cluster by 代替distribute by和sort by</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hive动态分区">Hive动态分区<a href="#hive动态分区" class="hash-link" aria-label="Direct link to Hive动态分区" title="Direct link to Hive动态分区">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hive动态分区参数配置">Hive动态分区参数配置<a href="#hive动态分区参数配置" class="hash-link" aria-label="Direct link to Hive动态分区参数配置" title="Direct link to Hive动态分区参数配置">​</a></h3>
<ul>
<li>往hive分区表中插入数据时，如果需要创建的分区很多，比如以表中某个字段进行分区存储，则需要复制粘贴修改很多sql去执行，效率低。因为hive是批处理系统，<strong>所以hive提供了一个动态分区功能，其可以基于查询参数的位置去推断分区的名称，从而建立分区。</strong></li>
</ul>
<p><strong>使用动态分区表必须配置的参数</strong></p>
<ul>
<li>set hive.exec.dynamic.partition =true（默认false）,表示开启动态分区功能；</li>
<li>set hive.exec.dynamic.partition.mode = nonstrict(默认strict),表示允许所有分区都是动态的，否则必须有静态分区字段；</li>
</ul>
<p><strong>动态分区相关调优参数</strong></p>
<ul>
<li>set hive.exec.max.dynamic.partitions.pernode=100 （默认100，一般可以设置大一点，比如1000）； 表示每个maper或reducer可以允许创建的最大动态分区个数，默认是100，超出则会报错。</li>
<li>set hive.exec.max.dynamic.partitions =1000(默认值) ； 表示一个动态分区语句可以创建的最大动态分区个数，超出报错；</li>
<li>set hive.exec.max.created.files =10000(默认) 全局可以创建的最大文件个数，超出报错</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="动态分区的问题">动态分区的问题<a href="#动态分区的问题" class="hash-link" aria-label="Direct link to 动态分区的问题" title="Direct link to 动态分区的问题">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="问题的引入">问题的引入<a href="#问题的引入" class="hash-link" aria-label="Direct link to 问题的引入" title="Direct link to 问题的引入">​</a></h4>
<p>在hive sql中使用动态分区非常方便，也比较常用，但是在使用的过程中会带来一些问题。</p>
<p>比如：在一段sql语句中我需要指定两个字段当做动态分区，一个字段的基数为7，另一个为4，这就是28个分区，当sql语句的最后一个job是一个仅有map阶段的任务，此时如果数据量有4000个map，那么这种情况下map任务在往hive分区中写的时候，每个map几乎都要产生28个文件，这样就会产生4000*28个文件，带来大量的小文件。比如如下一个简单的sql:</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">insert overwrite table test1 partition(week,type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select * from test_table;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个sql只有map任务，在数据量的情况下可能会产生大量的map，导致产生大量的小文件，实际上不仅仅是最后一个job只有map的任务有影响，reduce同样如此，但是一般情况下reduce的数目不会太大，并且reduce数目比较好控制</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a href="#解决方案" class="hash-link" aria-label="Direct link to 解决方案" title="Direct link to 解决方案">​</a></h4>
<p>最后一个阶段只有map，若是有reduce的话，可以把相同分区的数据发送到一个reduce处理</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">insert overwrite table test1 partition(week,type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from test_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISTRIBUTE BY week,type;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样的话产生的文件数就等于分区数目了（在不限制reduce的情况下），文件数目大大减小，但是文件数目也太少了吧，并且由于数据分布不均匀，分区下的文件大小差异特别大。并且由于不同reduce处理的数据量差异，造成部分reduce执行速度过慢，影响了整体的速度。</p>
<p>若是想把数据均匀的分配的reduce上，DISTRIBUTE BY的字段就不能使用分区下的字段，可以使用DISTRIBUTE BY rand(),这样rand取哈希然后对reduce数目取余，保证了每条数据分配到所有reduce的可能性是相等的，这样reduce处理的数据量就是均匀的，在数据量比较大的情况下每个reduce产生的文件数为动态分区的个数，产生的文件为reduceTask数*分区个数。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set hive.exec.reducers.max=500;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">insert overwrite table test1 partition(week,type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from test_table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DISTRIBUTE BY rand();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样产生的文件数就大大减少了。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Hive/Hive调优"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Hive调优</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Hive/Hive经典面试SQL"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Hive经典面试SQL</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#排名函数" class="table-of-contents__link toc-highlight">排名函数</a><ul><li><a href="#row_number" class="table-of-contents__link toc-highlight">ROW_NUMBER()</a></li><li><a href="#rank" class="table-of-contents__link toc-highlight">RANK()</a></li><li><a href="#dense_rank" class="table-of-contents__link toc-highlight">DENSE_RANK()</a></li></ul></li><li><a href="#窗口函数" class="table-of-contents__link toc-highlight">窗口函数</a><ul><li><a href="#定义" class="table-of-contents__link toc-highlight">定义</a></li><li><a href="#窗口边界" class="table-of-contents__link toc-highlight">窗口边界</a></li><li><a href="#窗口聚合函数" class="table-of-contents__link toc-highlight">窗口聚合函数</a></li><li><a href="#窗口排名函数" class="table-of-contents__link toc-highlight">窗口排名函数</a></li><li><a href="#值窗口函数" class="table-of-contents__link toc-highlight">值窗口函数</a></li></ul></li><li><a href="#表生成函数" class="table-of-contents__link toc-highlight">表生成函数</a><ul><li><a href="#explode" class="table-of-contents__link toc-highlight">Explode</a></li><li><a href="#posexplode" class="table-of-contents__link toc-highlight">posexplode</a></li><li><a href="#json_tuple" class="table-of-contents__link toc-highlight">json_tuple</a></li></ul></li><li><a href="#lateral-view侧视图" class="table-of-contents__link toc-highlight">LATERAL VIEW侧视图</a></li><li><a href="#排序" class="table-of-contents__link toc-highlight">排序</a><ul><li><a href="#order-by" class="table-of-contents__link toc-highlight">Order By</a></li><li><a href="#sort-by" class="table-of-contents__link toc-highlight">Sort By</a></li><li><a href="#distribute-by" class="table-of-contents__link toc-highlight">distribute by</a></li><li><a href="#cluster-by" class="table-of-contents__link toc-highlight">cluster by</a></li></ul></li><li><a href="#hive动态分区" class="table-of-contents__link toc-highlight">Hive动态分区</a><ul><li><a href="#hive动态分区参数配置" class="table-of-contents__link toc-highlight">Hive动态分区参数配置</a></li><li><a href="#动态分区的问题" class="table-of-contents__link toc-highlight">动态分区的问题</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>