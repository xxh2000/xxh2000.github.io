<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Hive/Hive调优" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Hive调优 | 大数据Guide</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/docs/Hive/Hive调优"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Hive调优 | 大数据Guide"><meta data-rh="true" name="description" content="语法优化"><meta data-rh="true" property="og:description" content="语法优化"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/docs/Hive/Hive调优"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/Hive/Hive调优" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/docs/Hive/Hive调优" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="大数据Guide RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="大数据Guide Atom Feed"><link rel="stylesheet" href="/assets/css/styles.69f2a557.css">
<script src="/assets/js/runtime~main.9ccc24a5.js" defer="defer"></script>
<script src="/assets/js/main.901e4aca.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">大数据Guide</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Flink/Flink SQL JOIN原理">大数据</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Flink/Flink SQL JOIN原理">Flink</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Hadoop/Hadoop实践">Hadoop</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/Hive/Hive调优">Hive</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Hive/Hive调优">Hive调优</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hive/Hive实践">Hive实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hive/Hive经典面试SQL">Hive经典面试SQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Hive/hive面试题">hive面试题</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Kafka/Kafka实践">Kafka</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/OLAP/Clickhouse/Clickhouse存算分离">OLAP</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Spark/Spark面试题1">Spark</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/Zookeeper/Zookeeper面试题">Zookeeper</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/其他/Flume面试题">其他</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/数据仓库/数仓架构建设方法论">数据仓库</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/数据湖/Iceberg/Iceberg实践">数据湖</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Hive</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Hive调优</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Hive调优</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="语法优化">语法优化<a href="#语法优化" class="hash-link" aria-label="Direct link to 语法优化" title="Direct link to 语法优化">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分组聚合优化">分组聚合优化<a href="#分组聚合优化" class="hash-link" aria-label="Direct link to 分组聚合优化" title="Direct link to 分组聚合优化">​</a></h3>
<p>Hive中未经优化的分组聚合，是通过一个MapReduce Job实现的。Map端负责读取数据，并按照分组字段分区，通过Shuffle，将数据发往Reduce端，各组数据在Reduce端完成最终的聚合运算。
Hive对分组聚合的优化主要围绕着减少Shuffle数据量进行，具体做法是map-side聚合。所谓map-side聚合，就是在map端维护一个hash table，利用其完成部分的聚合，然后将部分聚合的结果，按照分组字段分区，发送至reduce端，完成最终的聚合。map-side聚合能有效减少shuffle的数据量，提高分组聚合运算的效率。</p>
<blockquote>
<p>map-side 聚合相关的参数如下：</p>
</blockquote>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">--启用map-side聚合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> hive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aggr</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">--用于检测源表数据是否适合进行map-side聚合。检测的方法是：先对若干条数据进行map-side聚合，若聚合后的条数和聚合前的条数比值小于该值，则认为该表适合进行map-side聚合；否则，认为该表数据不适合进行map-side聚合，后续数据便不再进行map-side聚合。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> hive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aggr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">hash</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reduction</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">--用于检测源表是否适合map-side聚合的条数。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> hive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">groupby</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mapaggr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">checkinterval</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">--map-side聚合所用的hash table，占用map task堆内存的最大比例，若超出该值，则会对hash table进行一次flush。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> hive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aggr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">hash</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">force</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flush</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">memory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threshold</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.9</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="join-优化">JOIN 优化<a href="#join-优化" class="hash-link" aria-label="Direct link to JOIN 优化" title="Direct link to JOIN 优化">​</a></h3>
<p>Hive拥有多种join算法，包括Common Join，Map Join，Bucket Map Join，Sort Merge Buckt Map Join等，下面对每种join算法做简要说明：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="join-算法">JOIN 算法<a href="#join-算法" class="hash-link" aria-label="Direct link to JOIN 算法" title="Direct link to JOIN 算法">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="common-join">Common JOIN<a href="#common-join" class="hash-link" aria-label="Direct link to Common JOIN" title="Direct link to Common JOIN">​</a></h5>
<p>Common Join是Hive中最稳定的join算法，其通过一个MapReduce Job完成一个join操作。Map端负责读取join操作所需表的数据，并按照关联字段进行分区，通过Shuffle，将其发送到Reduce端，相同key的数据在Reduce端完成最终的Join操作。如下图所示</p>
<p><img decoding="async" loading="lazy" alt="img.png" src="/assets/images/img-8894e07423d9e57c4ee4d2129d8197dd.png" width="641" height="479" class="img_ev3q"></p>
<p>需要注意的是，sql语句中的join操作和执行计划中的Common Join任务并非一对一的关系，一个sql语句中的相邻的且关联字段相同的多个join操作可以合并为一个Common Join任务。</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="map-join">Map JOIN<a href="#map-join" class="hash-link" aria-label="Direct link to Map JOIN" title="Direct link to Map JOIN">​</a></h5>
<p>Map Join算法可以通过两个只有map阶段的Job完成一个join操作。其适用场景为大表join小表。若某join操作满足要求，则第一个Job会读取小表数据，将其制作为hash table，并上传至Hadoop分布式缓存（本质上是上传至HDFS）。第二个Job会先从分布式缓存中读取小表数据，并缓存在Map Task的内存中，然后扫描大表数据，这样在map端即可完成关联操作。如下图所示：
<img decoding="async" loading="lazy" alt="img_1.png" src="/assets/images/img_1-74a44b7a3374ac249f9e7a3ced6b2282.png" width="865" height="514" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="bucket-map-join">Bucket Map JOIN<a href="#bucket-map-join" class="hash-link" aria-label="Direct link to Bucket Map JOIN" title="Direct link to Bucket Map JOIN">​</a></h5>
<p>Bucket Map Join是对Map Join算法的改进，其打破了Map Join只适用于大表join小表的限制，可用于大表join大表的场景。
Bucket Map Join的核心思想是：若能保证参与join的表均为分桶表，且关联字段为分桶字段，且其中一张表的分桶数量是另外一张表分桶数量的整数倍，就能保证参与join的两张表的分桶之间具有明确的关联关系，所以就可以在两表的分桶间进行Map Join操作了。这样一来，第二个Job的Map端就无需再缓存小表的全表数据了，而只需缓存其所需的分桶即可。其原理如图所示：
<img decoding="async" loading="lazy" alt="img_4.png" src="/assets/images/img_4-07708a1028a3539cda4541a08607d1b4.png" width="556" height="273" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="sort-merge-bucket-map-join">Sort Merge Bucket Map Join<a href="#sort-merge-bucket-map-join" class="hash-link" aria-label="Direct link to Sort Merge Bucket Map Join" title="Direct link to Sort Merge Bucket Map Join">​</a></h5>
<p>（简称SMB Map Join）基于Bucket Map Join。SMB Map Join要求，参与join的表均为分桶表，且需保证分桶内的数据是有序的，且分桶字段、排序字段和关联字段为相同字段，且其中一张表的分桶数量是另外一张表分桶数量的整数倍。
SMB Map Join同Bucket Join一样，同样是利用两表各分桶之间的关联关系，在分桶之间进行join操作，不同的是，分桶之间的join操作的实现原理。Bucket Map Join，两个分桶之间的join实现原理为Hash Join算法；而SMB Map Join，两个分桶之间的join实现原理为Sort Merge Join算法。
Hash Join和Sort Merge Join均为关系型数据库中常见的Join实现算法。Hash Join的原理相对简单，就是对参与join的一张表构建hash table，然后扫描另外一张表，然后进行逐行匹配。Sort Merge Join需要在两张按照关联字段排好序的表中进行，其原理如图所示：</p>
<p><img decoding="async" loading="lazy" alt="img_3.png" src="/assets/images/img_3-55d8b2df56d32cf1fbfc50ac37309ec7.png" width="556" height="271" class="img_ev3q"></p>
<p>Hive中的SMB Map Join就是对两个分桶的 数据按照上述思路进行Join操作。可以看出，SMB Map Join与Bucket Map Join相比，在进行Join操作时，Map端是无需对整个Bucket构建hash table，也无需在Map端缓存整个Bucket数据的，每个Mapper只需按顺序逐个key读取两个分桶的数据进行join即可</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="map-join-优化">Map JOIN 优化<a href="#map-join-优化" class="hash-link" aria-label="Direct link to Map JOIN 优化" title="Direct link to Map JOIN 优化">​</a></h4>
<p>Map Join有两种触发方式，一种是用户在SQL语句中增加hint提示，另外一种是Hive优化器根据参与join表的数据量大小，自动触发。
1）Hint提示</p>
<p>用户可通过如下方式，指定通过map join算法，并且ta将作为map join中的小表。这种方式已经过时，不推荐使用。</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hive (default)&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select /*+ mapjoin(ta) */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ta.id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tb.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from table_a ta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">join table_b tb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">on ta.id=tb.id;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）自动触发</p>
<p>Hive在编译SQL语句阶段，起初所有的join操作均采用Common Join算法实现。
之后在物理优化阶段，Hive会根据每个Common Join任务所需表的大小判断该Common Join任务是否能够转换为Map Join任务，若满足要求，便将Common Join任务自动转换为Map Join任务。
但有些Common Join任务所需的表大小，在SQL的编译阶段是未知的（例如对子查询进行join操作），所以这种Common Join任务是否能转换成Map Join任务在编译阶是无法确定的。
针对这种情况，Hive会在编译阶段生成一个条件任务（Conditional Task），其下会包含一个计划列表，计划列表中包含转换后的Map Join任务以及原有的Common Join任务。最终具体采用哪个计划，是在运行时决定.
相关参数如下：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--启动Map Join自动转换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.auto.convert.join=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--一个Common Join operator转为Map Join operator的判断条件,若该Common Join相关的表中,存在n-1张表的已知大小总和&lt;=该值,则生成一个Map Join计划,此时可能存在多种n-1张表的组合均满足该条件,则hive会为每种满足条件的组合均生成一个Map Join计划,同时还会保留原有的Common Join计划作为后备(back up)计划,实际运行时,优先执行Map Join计划，若不能执行成功，则启动Common Join后备计划。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.mapjoin.smalltable.filesize=250000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--开启无条件转Map Join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.auto.convert.join.noconditionaltask=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--无条件转Map Join时的小表之和阈值,若一个Common Join operator相关的表中，存在n-1张表的大小总和&lt;=该值,此时hive便不会再为每种n-1张表的组合均生成Map Join计划,同时也不会保留Common Join作为后备计划。而是只生成一个最优的Map Join计划。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.auto.convert.join.noconditionaltask.size=10000000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="bucket-map-join优化">Bucket Map Join　优化<a href="#bucket-map-join优化" class="hash-link" aria-label="Direct link to Bucket Map Join　优化" title="Direct link to Bucket Map Join　优化">​</a></h4>
<p>Bucket Map Join不支持自动转换，发须通过用户在SQL语句中提供如下Hint提示，并配置如下相关参数，方可使用。</p>
<p>1）Hint提示</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hive (default)&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select /*+ mapjoin(ta) */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ta.id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tb.id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from table_a ta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">join table_b tb on ta.id=tb.id;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）相关参数</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--关闭cbo优化，cbo会导致hint信息被忽略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.cbo.enable=false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--map join hint默认会被忽略(因为已经过时)，需将如下参数设置为false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.ignore.mapjoin.hint=false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--启用bucket map join优化功能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.optimize.bucketmapjoin = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sort-merge-bucket-map-join-优化">Sort Merge Bucket Map Join 优化<a href="#sort-merge-bucket-map-join-优化" class="hash-link" aria-label="Direct link to Sort Merge Bucket Map Join 优化" title="Direct link to Sort Merge Bucket Map Join 优化">​</a></h4>
<p>Sort Merge Bucket Map Join有两种触发方式，包括Hint提示和自动转换。Hint提示已过时，不推荐使用。下面是自动转换的相关参数：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--启动Sort Merge Bucket Map Join优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.optimize.bucketmapjoin.sortedmerge=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--使用自动转换SMB Join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.auto.convert.sortmerge.join=true;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="数据倾斜优化">数据倾斜优化<a href="#数据倾斜优化" class="hash-link" aria-label="Direct link to 数据倾斜优化" title="Direct link to 数据倾斜优化">​</a></h3>
<p>数据倾斜问题，通常是指参与计算的数据分布不均，即某个key或者某些key的数据量远超其他key，导致在shuffle阶段，大量相同key的数据被发往同一个Reduce，进而导致该Reduce所需的时间远超其他Reduce，成为整个任务的瓶颈。
Hive中的数据倾斜常出现在分组聚合和join操作的场景中，下面分别介绍在上述两种场景下的优化思路。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="分组聚合数据倾斜">分组聚合数据倾斜<a href="#分组聚合数据倾斜" class="hash-link" aria-label="Direct link to 分组聚合数据倾斜" title="Direct link to 分组聚合数据倾斜">​</a></h4>
<p>Hive中未经优化的分组聚合，是通过一个MapReduce Job实现的。Map端负责读取数据，并按照分组字段分区，通过Shuffle，将数据发往Reduce端，各组数据在Reduce端完成最终的聚合运算。
如果group by分组字段的值分布不均，就可能导致大量相同的key进入同一Reduce，从而导致数据倾斜问题。
由分组聚合导致的数据倾斜问题，有以下两种解决思路：</p>
<p>1）Map-Side聚合</p>
<p>开启Map-Side聚合后，数据会现在Map端完成部分聚合工作。这样一来即便原始数据是倾斜的，经过Map端的初步聚合后，发往Reduce的数据也就不再倾斜了。最佳状态下，Map-端聚合能完全屏蔽数据倾斜问题。
相关参数如下：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--启用map-side聚合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.map.aggr=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--用于检测源表数据是否适合进行map-side聚合。检测的方法是：先对若干条数据进行map-side聚合，若聚合后的条数和聚合前的条数比值小于该值，则认为该表适合进行map-side聚合；否则，认为该表数据不适合进行map-side聚合，后续数据便不再进行map-side聚合。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.map.aggr.hash.min.reduction=0.5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--用于检测源表是否适合map-side聚合的条数。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.groupby.mapaggr.checkinterval=100000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--map-side聚合所用的hash table，占用map task堆内存的最大比例，若超出该值，则会对hash table进行一次flush。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.map.aggr.hash.force.flush.memory.threshold=0.9;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）Skew-GroupBy优化</p>
<p>Skew-GroupBy的原理是启动两个MR任务，第一个MR按照随机数分区，将数据分散发送到Reduce，完成部分聚合，第二个MR按照分组字段分区，完成最终聚合。
相关参数如下：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--启用分组聚合数据倾斜优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.groupby.skewindata=true;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>执行流程如下：</strong></p>
<ol>
<li>会生成两个job来执行group by，第一个job中，各个map是平均读取分片的，在map阶段对这个分片中的数据根据group by 的key进行局部聚合操作，这里就相当于Combiner操作。</li>
<li>在第一次的job中，map输出的结果随机分区，这样就可以平均分到reduce中</li>
<li>在第一次的job中，reduce中按照group by的key进行分组后聚合，这样就在各个reduce中又进行了一次局部的聚合。</li>
<li>因为第一个job中分区是随机的，所有reduce结果的数据的key也是随机的，所以第二个job的map读取的数据也是随机的key，所以第二个map中不存在数据倾斜的问题。</li>
<li>在第二个job的map中，也会进行一次局部聚合。</li>
<li>第二个job中分区是按照group by的key分区的，这个地方就保证了整体的group by没有问题，相同的key分到了同一个reduce中。</li>
<li>经过前面几个聚合的局部聚合，这个时候的数据量已经大大减少了，在最后一个reduce里进行最后的整体聚合</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="join数据倾斜">JOIN数据倾斜<a href="#join数据倾斜" class="hash-link" aria-label="Direct link to JOIN数据倾斜" title="Direct link to JOIN数据倾斜">​</a></h4>
<p>未经优化的join操作，默认是使用common join算法，也就是通过一个MapReduce Job完成计算。Map端负责读取join操作所需表的数据，并按照关联字段进行分区，通过Shuffle，将其发送到Reduce端，相同key的数据在Reduce端完成最终的Join操作。
如果关联字段的值分布不均，就可能导致大量相同的key进入同一Reduce，从而导致数据倾斜问题。
由join导致的数据倾斜问题，有如下三种解决方案</p>
<p>1）map join</p>
<p>使用map join算法，join操作仅在map端就能完成，没有shuffle操作，没有reduce阶段，自然不会产生reduce端的数据倾斜。该方案适用于大表join小表时发生数据倾斜的场景。
相关参数如下：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--启动Map Join自动转换</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.auto.convert.join=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--一个Common Join operator转为Map Join operator的判断条件,若该Common Join相关的表中,存在n-1张表的大小总和&lt;=该值,则生成一个Map Join计划,此时可能存在多种n-1张表的组合均满足该条件,则hive会为每种满足条件的组合均生成一个Map Join计划,同时还会保留原有的Common Join计划作为后备(back up)计划,实际运行时,优先执行Map Join计划，若不能执行成功，则启动Common Join后备计划。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.mapjoin.smalltable.filesize=250000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--开启无条件转Map Join</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.auto.convert.join.noconditionaltask=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--无条件转Map Join时的小表之和阈值,若一个Common Join operator相关的表中，存在n-1张表的大小总和&lt;=该值,此时hive便不会再为每种n-1张表的组合均生成Map Join计划,同时也不会保留Common Join作为后备计划。而是只生成一个最优的Map Join计划。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.auto.convert.join.noconditionaltask.size=10000000;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2）skew join</p>
<p>skew join的原理是，为倾斜的大key单独启动一个map join任务进行计算，其余key进行正常的common join。原理图如下：</p>
<p>相关参数如下：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--启用skew join优化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.optimize.skewjoin=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--触发skew join的阈值，若某个key的行数超过该参数值，则触发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.skewjoin.key=100000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">这种方案对参与join的源表大小没有要求，但是对两表中倾斜的key的数据量有要求，要求一张表中的倾斜key的数据量比较小（方便走mapjoin）。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3）调整SQL语句</p>
<p>若参与join的两表均为大表，其中一张表的数据是倾斜的，此时也可通过以下方式对SQL语句进行相应的调整。
假设原始SQL语句如下：A，B两表均为大表，且其中一张表的数据是倾斜的。</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">select</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">join B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  on A.id=B.id;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其join过程如下：
<img decoding="async" loading="lazy" alt="img_7.png" src="/assets/images/img_7-95c4090519e208ea7984b293c98349d1.png" width="520" height="238" class="img_ev3q"></p>
<p>图中1001为倾斜的大key，可以看到，其被发往了同一个Reduce进行处理。</p>
<p>调整SQL语句如下：</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">select</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        select --打散操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               concat(id,&#x27;_&#x27;,cast(rand()*2 as int)) id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )ta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        join(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select --扩容操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           concat(id,&#x27;_&#x27;,0) id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    union all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    select</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        concat(id,&#x27;_&#x27;,1) id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)tb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            on ta.id=tb.id;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>调整之后的SQL语句执行计划如下图所示</p>
<p><img decoding="async" loading="lazy" alt="img_6.png" src="/assets/images/img_6-6f2449c9c1bcea45c822a76e4b5cd714.png" width="536" height="244" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="任务并行度优化">任务并行度优化<a href="#任务并行度优化" class="hash-link" aria-label="Direct link to 任务并行度优化" title="Direct link to 任务并行度优化">​</a></h3>
<p>对于一个分布式的计算任务而言，设置一个合适的并行度十分重要。Hive的计算任务由MapReduce完成，故并行度的调整需要分为Map端和Reduce端。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="map端并行度">Map端并行度<a href="#map端并行度" class="hash-link" aria-label="Direct link to Map端并行度" title="Direct link to Map端并行度">​</a></h4>
<p>Map端的并行度，也就是Map的个数。是由输入文件的切片数决定的。一般情况下，Map端的并行度无需手动调整。
以下特殊情况可考虑调整map端并行度：</p>
<p><strong>1）查询的表中存在大量小文件</strong></p>
<p>按照Hadoop默认的切片策略，一个小文件会单独启动一个map task负责计算。若查询的表中存在大量小文件，则会启动大量map task，造成计算资源的浪费。这种情况下，可以使用Hive提供的CombineHiveInputFormat，多个小文件合并为一个切片，从而控制map task个数。相关参数如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">set hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2）map端有复杂的查询逻辑</strong></p>
<p>若SQL语句中有正则替换、json解析等复杂耗时的查询逻辑时，map端的计算会相对慢一些。若想加快计算速度，在计算资源充足的情况下，可考虑增大map端的并行度，令map task多一些，每个map task计算的数据少一些。</p>
<p>相关参数如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--一个切片的最大值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set mapreduce.input.fileinputformat.split.maxsize=256000000;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="reduce端并行度">Reduce端并行度<a href="#reduce端并行度" class="hash-link" aria-label="Direct link to Reduce端并行度" title="Direct link to Reduce端并行度">​</a></h4>
<p>Reduce端的并行度，也就是Reduce个数。相对来说，更需要关注。Reduce端的并行度，可由用户自己指定，也可由Hive自行根据该MR Job输入的文件大小进行估算。</p>
<p>Reduce端的并行度的相关参数如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--指定Reduce端并行度，默认值为-1，表示用户未指定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set mapreduce.job.reduces;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--Reduce端并行度最大值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.exec.reducers.max;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--单个Reduce Task计算的数据量，用于估算Reduce并行度</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.exec.reducers.bytes.per.reducer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reduce端并行度的确定逻辑如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">若指定参数mapreduce.job.reduces的值为一个非负整数，则Reduce  并行度为指定值。否则，Hive自行估算Reduce并行度，估算逻辑如下：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">假设Job输入的文件大小为totalInputBytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">参数hive.exec.reducers.bytes.per.reducer的值为bytesPerReducer。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">参数hive.exec.reducers.max的值为maxReducers。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>则Reduce端的并行度为：</p>
<p><img decoding="async" loading="lazy" alt="img_8.png" src="data:image/png;base64,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" width="370" height="51" class="img_ev3q"></p>
<p>根据上述描述，可以看出，Hive自行估算Reduce并行度时，是以整个MR Job输入的文件大小作为依据的。因此，在某些情况下其估计的并行度很可能并不准确，此时就需要用户根据实际情况来指定Reduce并行度了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="小文件合并优化">小文件合并优化<a href="#小文件合并优化" class="hash-link" aria-label="Direct link to 小文件合并优化" title="Direct link to 小文件合并优化">​</a></h3>
<p>小文件合并优化，分为两个方面，分别是Map端输入的小文件合并，和Reduce端输出的小文件合并。</p>
<p><strong>Map端输入文件合并</strong></p>
<p>合并Map端输入的小文件，是指将多个小文件划分到一个切片中，进而由一个Map Task去处理。目的是防止为单个小文件启动一个Map Task，浪费计算资源。</p>
<p>相关参数为:</p>
<div class="language-hiveql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-hiveql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--可将多个小文件切片，合并为一个切片，进而由一个map任务处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat; </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong><strong>Reduce输出文件合并</strong></strong></p>
<p>合并Reduce端输出的小文件，是指将多个小文件合并成大文件。目的是减少HDFS小文件数量。其原理是根据计算任务输出文件的平均大小进行判断，若符合条件，则单独启动一个额外的任务进行合并。</p>
<p>相关参数为:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--开启合并map only任务输出的小文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.merge.mapfiles=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--开启合并map reduce任务输出的小文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.merge.mapredfiles=true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--合并后的文件大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.merge.size.per.task=256000000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--触发小文件合并任务的阈值，若某计算任务输出的文件平均大小低于该值，则触发合并</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set hive.merge.smallfiles.avgsize=16000000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="其他优化">其他优化<a href="#其他优化" class="hash-link" aria-label="Direct link to 其他优化" title="Direct link to 其他优化">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cbo优化">CBO优化<a href="#cbo优化" class="hash-link" aria-label="Direct link to CBO优化" title="Direct link to CBO优化">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="谓词下推">谓词下推<a href="#谓词下推" class="hash-link" aria-label="Direct link to 谓词下推" title="Direct link to 谓词下推">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="本地模式">本地模式<a href="#本地模式" class="hash-link" aria-label="Direct link to 本地模式" title="Direct link to 本地模式">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="并行执行">并行执行<a href="#并行执行" class="hash-link" aria-label="Direct link to 并行执行" title="Direct link to 并行执行">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="严格模式">严格模式<a href="#严格模式" class="hash-link" aria-label="Direct link to 严格模式" title="Direct link to 严格模式">​</a></h4>
<p>Hive可以通过设置某些参数防止危险操作：</p>
<p><strong>1）分区表不使用分区过滤</strong></p>
<p>将hive.strict.checks.no.partition.filter设置为true时，对于分区表，除非where语句中含有分区字段过滤条件来限制范围，否则不允许执行。换句话说，就是用户不允许扫描所有分区。进行这个限制的原因是，通常分区表都拥有非常大的数据集，而且数据增加迅速。没有进行分区限制的查询可能会消耗令人不可接受的巨大资源来处理这个表。</p>
<p><strong>2）使用order by没有limit过滤</strong></p>
<p>将hive.strict.checks.orderby.no.limit设置为true时，对于使用了order by语句的查询，要求必须使用limit语句。因为order by为了执行排序过程会将所有的结果数据分发到同一个Reduce中进行处理，强制要求用户增加这个limit语句可以防止Reduce额外执行很长一段时间（开启了limit可以在数据进入到Reduce之前就减少一部分数据）。</p>
<p><strong>3）笛卡尔积</strong></p>
<p>将hive.strict.checks.cartesian.product设置为true时，会限制笛卡尔积的查询。对关系型数据库非常了解的用户可能期望在执行JOIN查询的时候不使用ON语句而是使用where语句，这样关系数据库的执行优化器就可以高效地将WHERE语句转化成那个ON语句。不幸的是，Hive并不会执行这种优化，因此，如果表足够大，那么这个查询就会出现不可控的情况。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="参数优化">参数优化<a href="#参数优化" class="hash-link" aria-label="Direct link to 参数优化" title="Direct link to 参数优化">​</a></h3>
<p>总结上面的各种优化方式,其中大部分  与Hive 参数有关系,这里对这些参数做个总结</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="资料">资料<a href="#资料" class="hash-link" aria-label="Direct link to 资料" title="Direct link to 资料">​</a></h3>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1779081" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1779081</a></li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Hadoop/Hbase面试题"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Hbase面试题</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Hive/Hive实践"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Hive实践</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#语法优化" class="table-of-contents__link toc-highlight">语法优化</a><ul><li><a href="#分组聚合优化" class="table-of-contents__link toc-highlight">分组聚合优化</a></li><li><a href="#join-优化" class="table-of-contents__link toc-highlight">JOIN 优化</a><ul><li><a href="#join-算法" class="table-of-contents__link toc-highlight">JOIN 算法</a><ul><li><a href="#common-join" class="table-of-contents__link toc-highlight">Common JOIN</a></li><li><a href="#map-join" class="table-of-contents__link toc-highlight">Map JOIN</a></li><li><a href="#bucket-map-join" class="table-of-contents__link toc-highlight">Bucket Map JOIN</a></li><li><a href="#sort-merge-bucket-map-join" class="table-of-contents__link toc-highlight">Sort Merge Bucket Map Join</a></li></ul></li><li><a href="#map-join-优化" class="table-of-contents__link toc-highlight">Map JOIN 优化</a></li><li><a href="#bucket-map-join优化" class="table-of-contents__link toc-highlight">Bucket Map Join　优化</a></li><li><a href="#sort-merge-bucket-map-join-优化" class="table-of-contents__link toc-highlight">Sort Merge Bucket Map Join 优化</a></li></ul></li><li><a href="#数据倾斜优化" class="table-of-contents__link toc-highlight">数据倾斜优化</a><ul><li><a href="#分组聚合数据倾斜" class="table-of-contents__link toc-highlight">分组聚合数据倾斜</a></li><li><a href="#join数据倾斜" class="table-of-contents__link toc-highlight">JOIN数据倾斜</a></li></ul></li><li><a href="#任务并行度优化" class="table-of-contents__link toc-highlight">任务并行度优化</a><ul><li><a href="#map端并行度" class="table-of-contents__link toc-highlight">Map端并行度</a></li><li><a href="#reduce端并行度" class="table-of-contents__link toc-highlight">Reduce端并行度</a></li></ul></li><li><a href="#小文件合并优化" class="table-of-contents__link toc-highlight">小文件合并优化</a></li><li><a href="#其他优化" class="table-of-contents__link toc-highlight">其他优化</a><ul><li><a href="#cbo优化" class="table-of-contents__link toc-highlight">CBO优化</a></li><li><a href="#谓词下推" class="table-of-contents__link toc-highlight">谓词下推</a></li><li><a href="#本地模式" class="table-of-contents__link toc-highlight">本地模式</a></li><li><a href="#并行执行" class="table-of-contents__link toc-highlight">并行执行</a></li><li><a href="#严格模式" class="table-of-contents__link toc-highlight">严格模式</a></li></ul></li><li><a href="#参数优化" class="table-of-contents__link toc-highlight">参数优化</a></li><li><a href="#资料" class="table-of-contents__link toc-highlight">资料</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>